
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../commonstatsmethods/">
      
      
        <link rel="next" href="../simplifiedlikelihood/">
      
      
      <link rel="icon" href="../../logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Advanced use cases - Combine</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../mystyle.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-use-cases" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../.."> 


    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Combine" class="md-header__button md-logo" aria-label="Combine" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Combine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced use cases
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../what_combine_does/introduction/" class="md-tabs__link">
          
  
  
    
  
  What Combine Does

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part2/settinguptheanalysis/" class="md-tabs__link">
          
  
  
    
  
  Setting up the analysis

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../runningthetool/" class="md-tabs__link">
          
  
  
    
  
  Running combine

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part5/roofit/" class="md-tabs__link">
          
  
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../part4/usefullinks/" class="md-tabs__link">
        
  
  
    
  
  Links & FAQ

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Combine" class="md-nav__button md-logo" aria-label="Combine" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    Combine
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    What Combine Does
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            What Combine Does
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/model_and_likelihood/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model and Likelihood
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/fitting_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fitting Concepts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/statistical_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Statistical Tests
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Setting up the analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Setting up the analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/settinguptheanalysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Preparing the datacard
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Physics models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Physics models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/physicsmodels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/higgscouplings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SM Higgs coupling models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/bsm-higgs-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BSM Higgs models
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/bin-wise-stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Automatic MC statistical uncertainties
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Running combine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Running combine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runningthetool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running the tool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commonstatsmethods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common statistical methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Advanced use cases
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Advanced use cases
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fit-diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      Fit Diagnostics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fit Diagnostics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fit-options" class="md-nav__link">
    <span class="md-ellipsis">
      Fit options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-parameter-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      Fit parameter uncertainties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-and-post-fit-nuisance-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Pre- and post-fit nuisance parameters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pre- and post-fit nuisance parameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pulls" class="md-nav__link">
    <span class="md-ellipsis">
      Pulls
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#normalizations" class="md-nav__link">
    <span class="md-ellipsis">
      Normalizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Normalizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-bin-norms-for-shape-analyses" class="md-nav__link">
    <span class="md-ellipsis">
      Per-bin norms for shape analyses
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toy-by-toy-diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      Toy-by-toy diagnostics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling constraints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuisance-parameter-impacts" class="md-nav__link">
    <span class="md-ellipsis">
      Nuisance parameter impacts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#breakdown-of-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      Breakdown of uncertainties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#channel-masking" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Masking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Channel Masking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-removing-constraints-from-the-signal-region" class="md-nav__link">
    <span class="md-ellipsis">
      Example: removing constraints from the signal region
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roomultipdf-conventional-bias-studies" class="md-nav__link">
    <span class="md-ellipsis">
      RooMultiPdf conventional bias studies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RooMultiPdf conventional bias studies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#discrete-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      Discrete profiling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roosplinend-multidimensional-splines" class="md-nav__link">
    <span class="md-ellipsis">
      RooSplineND multidimensional splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rooparametrichist-gamman-for-shapes" class="md-nav__link">
    <span class="md-ellipsis">
      RooParametricHist gammaN for shapes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#look-elsewhere-effect-for-one-parameter" class="md-nav__link">
    <span class="md-ellipsis">
      Look-elsewhere effect for one parameter
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simplifiedlikelihood/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Simplified Likelihoods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../regularisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unfolding & regularization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validating datacards
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging fit failures
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/roofit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RooFit Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Main Features
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Main Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/longexercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/longexerciseanswers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Solutions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial2023/parametric_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parametric Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial2023_unfolding/unfolding_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Likelihood Based Unfolding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial_stat_routines/stat_routines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Statitiscal Tests Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_building_tutorial2024/model_building_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model building
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../abcd_rooparametrichist_tutorial/rooparametrichist_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Per-bin Transfer Factors with Parametric Histograms
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/usefullinks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Links & FAQ
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fit-diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      Fit Diagnostics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fit Diagnostics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fit-options" class="md-nav__link">
    <span class="md-ellipsis">
      Fit options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-parameter-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      Fit parameter uncertainties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-and-post-fit-nuisance-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Pre- and post-fit nuisance parameters
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pre- and post-fit nuisance parameters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pulls" class="md-nav__link">
    <span class="md-ellipsis">
      Pulls
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#normalizations" class="md-nav__link">
    <span class="md-ellipsis">
      Normalizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Normalizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-bin-norms-for-shape-analyses" class="md-nav__link">
    <span class="md-ellipsis">
      Per-bin norms for shape analyses
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting" class="md-nav__link">
    <span class="md-ellipsis">
      Plotting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toy-by-toy-diagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      Toy-by-toy diagnostics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling constraints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nuisance-parameter-impacts" class="md-nav__link">
    <span class="md-ellipsis">
      Nuisance parameter impacts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#breakdown-of-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      Breakdown of uncertainties
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#channel-masking" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Masking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Channel Masking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-removing-constraints-from-the-signal-region" class="md-nav__link">
    <span class="md-ellipsis">
      Example: removing constraints from the signal region
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roomultipdf-conventional-bias-studies" class="md-nav__link">
    <span class="md-ellipsis">
      RooMultiPdf conventional bias studies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RooMultiPdf conventional bias studies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#discrete-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      Discrete profiling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roosplinend-multidimensional-splines" class="md-nav__link">
    <span class="md-ellipsis">
      RooSplineND multidimensional splines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rooparametrichist-gamman-for-shapes" class="md-nav__link">
    <span class="md-ellipsis">
      RooParametricHist gammaN for shapes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#look-elsewhere-effect-for-one-parameter" class="md-nav__link">
    <span class="md-ellipsis">
      Look-elsewhere effect for one parameter
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="advanced-use-cases">Advanced Use Cases</h1>
<p>This section will cover some of the more specific use cases for <span style="font-variant:small-caps;">Combine</span> that are not necessarily related to the main results of the analysis.</p>
<h2 id="fit-diagnostics">Fit Diagnostics</h2>
<p>If you want to diagnose your limits/fit results, you may first want to look at the HIG PAG standard checks, which are applied to all datacards and can be found <a href="https://twiki.cern.ch/twiki/bin/view/CMS/HiggsWG/HiggsPAGPreapprovalChecks">here</a>.</p>
<p>If you have already found the Higgs boson but it's an exotic one, instead of computing a limit or significance you might want to extract its cross section by performing a maximum-likelihood fit. Alternatively, you might want to know how compatible your data and your model are, e.g. how strongly your nuisance parameters are constrained, to what extent they are correlated, etc. These general diagnostic tools are contained in the method <code>FitDiagnostics</code>.</p>
<div class="highlight"><pre><span></span><code>    combine -M FitDiagnostics datacard.txt
</code></pre></div>
<p>The program will print out the result of <em>two fits</em>. The first one is performed with the signal strength <strong>r</strong> (or the first POI in the list, in models with multiple POIs) set to zero and a second with floating <strong>r</strong>. The output ROOT tree will contain the best fit value for <strong>r</strong> and its uncertainty. You will also get a <code>fitDiagnostics.root</code> file containing the following objects:</p>
<table>
<thead>
<tr>
<th>Object</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>nuisances_prefit</code></strong></td>
<td><code>RooArgSet</code> containing the pre-fit values of the nuisance parameters, and their uncertainties from the external constraint terms only</td>
</tr>
<tr>
<td><strong><code>fit_b</code></strong></td>
<td><code>RooFitResult</code> object containing the outcome of the fit of the data with signal strength set to zero</td>
</tr>
<tr>
<td><strong><code>fit_s</code></strong></td>
<td><code>RooFitResult</code> object containing the outcome of the fit of the data with floating signal strength</td>
</tr>
<tr>
<td><strong><code>tree_prefit</code></strong></td>
<td><code>TTree</code> of pre-fit nuisance parameter values and constraint terms (_In)</td>
</tr>
<tr>
<td><strong><code>tree_fit_sb</code></strong></td>
<td><code>TTree</code> of fitted nuisance parameter values and constraint terms (_In) with floating signal strength</td>
</tr>
<tr>
<td><strong><code>tree_fit_b</code></strong></td>
<td><code>TTree</code> of fitted nuisance parameter values and constraint terms (_In) with signal strength set to 0</td>
</tr>
</tbody>
</table>
<p>by including the option <code>--plots</code>, you will additionally find the following contained in the ROOT file:</p>
<table>
<thead>
<tr>
<th>Object</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>covariance_fit_s</code></strong></td>
<td><code>TH2D</code> Covariance matrix of the parameters in the fit with floating signal strength</td>
</tr>
<tr>
<td><strong><code>covariance_fit_b</code></strong></td>
<td><code>TH2D</code> Covariance matrix of the parameters in the fit with signal strength set to zero</td>
</tr>
<tr>
<td><strong><code>category_variable_prefit</code></strong></td>
<td><code>RooPlot</code> plot of the pre-fit PDFs/templates with the data (or toy if running with <code>-t</code>) overlaid</td>
</tr>
<tr>
<td><strong><code>category_variable_fit_b</code></strong></td>
<td><code>RooPlot</code> plot of the PDFs/templates from the background only fit with the data (or toy if running with <code>-t</code>) overlaid</td>
</tr>
<tr>
<td><strong><code>category_variable_fit_s</code></strong></td>
<td><code>RooPlot</code> plot of the PDFs/templates from the signal+background fit with the data (or toy if running with <code>-t</code>) overlaid</td>
</tr>
</tbody>
</table>
<p>There will be one <code>RooPlot</code> object per category in the likelihood, and one per variable if using a multi-dimensional dataset. For each of these additional objects a png file will also be produced.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you use the option <code>--name</code>, this additional name will be inserted into the file name for this output file.</p>
</div>
<p>As well as the values of the constrained nuisance parameters (and their constraints), you will also find branches for the number of "bad" nll calls (which you should check is not too large) and the status of the fit <code>fit_status</code>. The fit status is computed as follows</p>
<div class="highlight"><pre><span></span><code>fit_status = 100 * hesse_status + 10 * minos_status +  minuit_summary_status
</code></pre></div>
<p>The <code>minuit_summary_status</code> is the usual status from Minuit, details of which can be found <a href="https://root.cern/doc/master/classROOT_1_1Minuit2_1_1Minuit2Minimizer.html#ad5dfca9a592a7bbbbe0a14b567bb2470">here</a>. For the other status values, check these documentation links for the <a href="https://root.cern/doc/master/classROOT_1_1Minuit2_1_1Minuit2Minimizer.html#a5a7d89e3a2911c4819a6182475d7636c"><code>hesse_status</code></a> and the <a href="https://root.cern/doc/master/classROOT_1_1Minuit2_1_1Minuit2Minimizer.html#a5ef2583ce3beea4b3e192c27d747297b"><code>minos_status</code></a>.</p>
<p>A fit status of -1 indicates that the fit failed (Minuit summary was not 0 or 1) and hence the fit result is <strong>not</strong> valid.</p>
<h3 id="fit-options">Fit options</h3>
<ul>
<li>If you only want to run the signal+background fit, and do not need the output file, you can run with <code>--justFit</code>. In case you would like to run only the signal+background fit but would like to produce the output file, you should use the option <code>--skipBOnlyFit</code> instead.</li>
<li>You can use <code>--rMin</code> and <code>--rMax</code> to set the range of the first POI; a range that is not too large compared with the uncertainties you expect from the fit usually gives more stable and accurate results.</li>
<li>By default, the uncertainties are computed using MINOS for the first POI and HESSE for all other parameters. For the nuisance parameters the uncertainties will therefore be symmetric. You can run MINOS for <em>all</em> parameters using the option <code>--minos all</code>, or for <em>none</em> of the parameters using <code>--minos none</code>. Note that running MINOS is slower so you should only consider using it if you think the HESSE uncertainties are not accurate.</li>
<li>If MINOS or HESSE fails to converge, you can try running with <code>--robustFit=1</code>. This will do a slower, but more robust, likelihood scan, which can be further controlled with the parameter <code>--stepSize</code> (the default value is 0.1, and is relative to the range of the parameter).</li>
<li>The strategy and tolerance when using the <code>--robustFit</code> option can be set using the options <code>setRobustFitAlgo</code> (default is <code>Minuit2,migrad</code>), <code>setRobustFitStrategy</code> (default is 0) and <code>--setRobustFitTolerance</code> (default is 0.1). If these options are not set, the defaults (set using <code>cminDefaultMinimizerX</code> options) will be used. You can also tune the accuracy of the routine used to find the crossing points of the likelihood using the option <code>--setCrossingTolerance</code> (the default is set to 0.0001)</li>
<li>If you find the covariance matrix provided by HESSE is not accurate (i.e. <code>fit_s-&gt;Print()</code> reports this was forced positive-definite) then a custom HESSE-style calculation of the covariance matrix can be used instead. This is enabled by running <code>FitDiagnostics</code> with the <code>--robustHesse 1</code> option. Please note that the status reported by <code>RooFitResult::Print()</code> will contain <code>covariance matrix quality: Unknown, matrix was externally provided</code> when robustHesse is used, this is normal and does not indicate a problem. NB: one feature of the robustHesse algorithm is that if it still cannot calculate a positive-definite covariance matrix it will try to do so by dropping parameters from the hessian matrix before inverting. If this happens it will be reported in the output to the screen.</li>
<li>For other fitting options see the <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/wiki/runningthetool#generic-minimizer-options">generic minimizer options</a> section.</li>
</ul>
<h3 id="fit-parameter-uncertainties">Fit parameter uncertainties</h3>
<p>If you get a warning message when running <code>FitDiagnostics</code> that says <code>Unable to determine uncertainties on all fit parameters</code>. This means the covariance matrix calculated in <code>FitDiagnostics</code> was not correct.</p>
<p>The most common problem is that the covariance matrix is forced positive-definite. In this case the constraints on fit parameters as taken from the covariance matrix are incorrect and should not be used. In particular, if you want to make post-fit plots of the distribution used in the signal extraction fit and are extracting the uncertainties on the signal and background expectations from the covariance matrix, the resulting values will not reflect the truth if the covariance matrix was incorrect. By default if this happens and you passed the <code>--saveWithUncertainties</code> flag when calling <code>FitDiagnostics</code>, this option will be ignored as calculating the uncertainties would lead to incorrect results. This behaviour can be overridden by passing <code>--ignoreCovWarning</code>.</p>
<p>Such problems with the covariance matrix can be caused by a number of things, for example:</p>
<ul>
<li>
<p>Parameters being close to their boundaries after the fit.</p>
</li>
<li>
<p>Strong (anti-) correlations between some parameters.
  A discontinuity in the NLL function or its derivatives at or near the minimum.</p>
</li>
</ul>
<p>If you are aware that your analysis has any of these features you could try resolving these. Setting <code>--cminDefaultMinimizerStrategy 0</code> can also help with this problem.</p>
<h3 id="pre-and-post-fit-nuisance-parameters">Pre- and post-fit nuisance parameters</h3>
<p>It is possible to compare pre-fit and post-fit nuisance parameter values with the script <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/test/diffNuisances.py">diffNuisances.py</a>. Taking as input a <code>fitDiagnosticsTest.root</code> file, the script will by default print out the parameters that have changed significantly with respect to their initial estimate. </p>
<p>For each of those parameters, it will print out </p>
<ul>
<li>The shift in value and the post-fit uncertainty, both normalized to the initial (pre-fit) value from the s+b fit and the b-only fit. </li>
<li>The linear correlation between the parameter and the signal strength <code>r</code> - <span class="arithmatex">\(\rho(r,\nu)\)</span>.</li>
<li>The approximate impact of the nuisance parameter determined as <span class="arithmatex">\(I(r,\nu) = \sigma_{r}\sigma_{\nu}\rho(r,\nu)\)</span>, where <span class="arithmatex">\(\sigma_{r}\)</span> and <span class="arithmatex">\(\sigma_{\nu}\)</span> are the symmetrized total uncertainties on the signal strength and nuisance parameter, respectively (see the section on <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/latest/part3/nonstandard/#nuisance-parameter-impacts">Nuisance parameter impacts</a> for our recommend calculation of impacts.).</li>
</ul>
<p>The script has several options to toggle the thresholds used to decide whether a parameter has changed significantly, to get the printout of the absolute value of the nuisance parameters, and to get the output in another format for use on a webpage or in a note (the supported formats are <code>html</code>, <code>latex</code>, <code>twiki</code>). To print <em>all</em> of the parameters, use the option <code>--all</code>. </p>
<p>An example of using this script is shown below, </p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>data/tutorials/counting/realistic-counting-experiment.txt<span class="w"> </span>-M<span class="w"> </span>FitDiagnostics<span class="w"> </span>--forceRecreateNLL<span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">1</span>
python<span class="w"> </span>diffNuisances.py<span class="w"> </span>fitDiagnosticsTest.root
</code></pre></div>
<details>
<summary>Show output</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1"><code>--format text</code> (default)</label><label for="__tabbed_1_2"><code>--format html</code></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>diffNuisances<span class="w"> </span>run<span class="w"> </span>on<span class="w"> </span>fitDiagnosticsTest.root,<span class="w"> </span>at<span class="w"> </span><span class="m">2024</span>-07-01<span class="w"> </span><span class="m">18</span>:05:37.585109<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>options<span class="w"> </span>...<span class="w"> </span><span class="o">{</span><span class="s1">&#39;vtol&#39;</span>:<span class="w"> </span><span class="m">0</span>.3,<span class="w"> </span><span class="s1">&#39;stol&#39;</span>:<span class="w"> </span><span class="m">0</span>.1,<span class="w"> </span><span class="s1">&#39;vtol2&#39;</span>:<span class="w"> </span><span class="m">2</span>.0,<span class="w"> </span><span class="s1">&#39;stol2&#39;</span>:<span class="w"> </span><span class="m">0</span>.5,<span class="w"> </span><span class="s1">&#39;show_all_parameters&#39;</span>:<span class="w"> </span>False,<span class="w"> </span><span class="s1">&#39;absolute_values&#39;</span>:<span class="w"> </span>False,<span class="w"> </span><span class="s1">&#39;poi&#39;</span>:<span class="w"> </span><span class="s1">&#39;r&#39;</span>,<span class="w"> </span><span class="s1">&#39;format&#39;</span>:<span class="w"> </span><span class="s1">&#39;text&#39;</span>,<span class="w"> </span><span class="s1">&#39;plotfile&#39;</span>:<span class="w"> </span>None,<span class="w"> </span><span class="s1">&#39;pullDef&#39;</span>:<span class="w"> </span><span class="s1">&#39;&#39;</span>,<span class="w"> </span><span class="s1">&#39;skipFitS&#39;</span>:<span class="w"> </span>False,<span class="w"> </span><span class="s1">&#39;skipFitB&#39;</span>:<span class="w"> </span>False,<span class="w"> </span><span class="s1">&#39;sortBy&#39;</span>:<span class="w"> </span><span class="s1">&#39;correlation&#39;</span>,<span class="w"> </span><span class="s1">&#39;regex&#39;</span>:<span class="w"> </span><span class="s1">&#39;.*&#39;</span><span class="o">}</span>

name<span class="w">                                              </span>b-only<span class="w"> </span>fit<span class="w">            </span>s+b<span class="w"> </span>fit<span class="w">         </span>rho<span class="w">  </span>approx<span class="w"> </span>impact
CMS_scale_t_tautau_8TeV<span class="w">                          </span>-0.60,<span class="w"> </span><span class="m">0</span>.40<span class="w">     </span>!<span class="w"> </span>-0.73,<span class="w"> </span><span class="m">0</span>.39!<span class="w">     </span>!-0.19!<span class="w">      </span>-0.051
CMS_eff_t_tt_8TeV<span class="w">                                </span>+0.57,<span class="w"> </span><span class="m">0</span>.32<span class="w">     </span>!<span class="w"> </span>+0.50,<span class="w"> </span><span class="m">0</span>.32!<span class="w">     </span>!-0.17!<span class="w">      </span>-0.037
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_12<span class="w">         </span>+0.21,<span class="w"> </span><span class="m">0</span>.89<span class="w">        </span>-0.20,<span class="w"> </span><span class="m">0</span>.96<span class="w">       </span>-0.15<span class="w">      </span>-0.103
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_11<span class="w">         </span>+0.71,<span class="w"> </span><span class="m">0</span>.87<span class="w">        </span>+0.42,<span class="w"> </span><span class="m">0</span>.90<span class="w">       </span>-0.15<span class="w">      </span>-0.095
CMS_htt_QCDSyst_tauTau_vbf_8TeV<span class="w">                  </span>+0.16,<span class="w"> </span><span class="m">0</span>.82<span class="w">        </span>-0.15,<span class="w"> </span><span class="m">0</span>.84<span class="w">       </span>-0.12<span class="w">      </span>-0.071
CMS_htt_tt_tauTau_vbf_8TeV_ZTT_bin_6<span class="w">             </span>+0.32,<span class="w"> </span><span class="m">0</span>.97<span class="w">        </span>+0.09,<span class="w"> </span><span class="m">0</span>.99<span class="w">       </span>-0.08<span class="w">      </span>-0.054
CMS_htt_QCDSyst_tauTau_1jet_high_mediumhiggs_8TeV<span class="w">         </span>+0.52,<span class="w"> </span><span class="m">0</span>.20<span class="w">     </span>!<span class="w"> </span>+0.48,<span class="w"> </span><span class="m">0</span>.20!<span class="w">     </span>!-0.08!<span class="w">      </span>-0.011
CMS_htt_QCDSyst_tauTau_1jet_high_highhiggs_8TeV<span class="w">         </span>-0.15,<span class="w"> </span><span class="m">0</span>.84<span class="w">        </span>-0.33,<span class="w"> </span><span class="m">0</span>.84<span class="w">       </span>-0.08<span class="w">      </span>-0.044
CMS_htt_extrap_ztt_tauTau_1jet_high_mediumhiggs_8TeV<span class="w">         </span>+0.34,<span class="w"> </span><span class="m">0</span>.95<span class="w">        </span>+0.45,<span class="w"> </span><span class="m">0</span>.95<span class="w">       </span>+0.07<span class="w">      </span>+0.049
CMS_htt_extrap_ztt_tauTau_vbf_8TeV<span class="w">               </span>+0.31,<span class="w"> </span><span class="m">0</span>.96<span class="w">        </span>+0.14,<span class="w"> </span><span class="m">0</span>.96<span class="w">       </span>-0.06<span class="w">      </span>-0.040
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_14<span class="w">         </span>+0.29,<span class="w"> </span><span class="m">0</span>.88<span class="w">        </span>+0.24,<span class="w"> </span><span class="m">0</span>.89<span class="w">       </span>-0.03<span class="w">      </span>-0.018
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_6<span class="w">         </span>-0.67,<span class="w"> </span><span class="m">0</span>.94<span class="w">        </span>-0.63,<span class="w"> </span><span class="m">0</span>.93<span class="w">       </span>+0.02<span class="w">      </span>+0.014
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_23<span class="w">         </span>+0.44,<span class="w"> </span><span class="m">0</span>.92<span class="w">        </span>+0.46,<span class="w"> </span><span class="m">0</span>.92<span class="w">       </span>+0.01<span class="w">      </span>+0.004
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_18<span class="w">         </span>+0.44,<span class="w"> </span><span class="m">0</span>.92<span class="w">        </span>+0.43,<span class="w"> </span><span class="m">0</span>.93<span class="w">       </span>-0.01<span class="w">      </span>-0.005
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_17<span class="w">         </span>-0.62,<span class="w"> </span><span class="m">1</span>.00<span class="w">        </span>-0.61,<span class="w"> </span><span class="m">1</span>.00<span class="w">       </span>+0.01<span class="w">      </span>+0.004
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_15<span class="w">         </span>-0.55,<span class="w"> </span><span class="m">0</span>.98<span class="w">        </span>-0.54,<span class="w"> </span><span class="m">0</span>.98<span class="w">       </span>+0.01<span class="w">      </span>+0.005
CMS_htt_extrap_ztt_tauTau_1jet_high_highhiggs_8TeV<span class="w">         </span>-0.34,<span class="w"> </span><span class="m">0</span>.95<span class="w">        </span>-0.41,<span class="w"> </span><span class="m">0</span>.95<span class="w">       </span>-0.01<span class="w">      </span>-0.006
CMS_htt_tt_tauTau_1jet_high_mediumhiggs_8TeV_ZTT_bin_20<span class="w">         </span>-0.34,<span class="w"> </span><span class="m">0</span>.99<span class="w">        </span>-0.33,<span class="w"> </span><span class="m">0</span>.99<span class="w">       </span>+0.00<span class="w">      </span>+0.003
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_5<span class="w">         </span>-0.49,<span class="w"> </span><span class="m">1</span>.00<span class="w">        </span>-0.48,<span class="w"> </span><span class="m">1</span>.00<span class="w">       </span>+0.00<span class="w">      </span>+0.003
CMS_htt_tt_tauTau_1jet_high_highhiggs_8TeV_ZTT_bin_26<span class="w">         </span>-0.47,<span class="w"> </span><span class="m">0</span>.96<span class="w">        </span>-0.46,<span class="w"> </span><span class="m">0</span>.97<span class="w">       </span>+0.00<span class="w">      </span>+0.003
</code></pre></div>
</div>
<div class="tabbed-block">
<p><img alt="example dfn html" src="../images/exampledfhtml.jpg" /></p>
</div>
</div>
</div>
</details>
<p>By default, the changes in the nuisance parameter values and uncertainties are given relative to their initial (pre-fit) values (usually relative to initial values of 0 and 1 for most nuisance types).</p>
<p>The values in the output will be <span class="arithmatex">\((\nu-\nu_{I})/\sigma_{I}\)</span> if the nuisance has a pre-fit uncertainty, otherwise they will be <span class="arithmatex">\(\nu-\nu_{I}\)</span> (for example, a <code>flatParam</code> has no pre-fit uncertainty).</p>
<p>The reported uncertainty will be the ratio <span class="arithmatex">\(\sigma/\sigma_{I}\)</span> - i.e the ratio of the post-fit to the pre-fit uncertainty. If there is no pre-fit uncertainty (as for <code>flatParam</code> nuisances), the post-fit uncertainty is shown.</p>
<p>To print the pre-fit and post-fit values and (asymmetric) uncertainties, rather than the ratios, the option <code>--abs</code> can be used.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We recommend that you include the options <code>--abs</code> and <code>--all</code> to get the full information on all of the parameters (including unconstrained nuisance parameters) at least once when checking your datacards. </p>
</div>
<h4 id="pulls">Pulls</h4>
<p>If instead of the nuisance parameter values, you wish to report the <em>pulls</em>, you can do so using the option <code>--pullDef X</code>, with <code>X</code> being one of the options listed below. You should note that since the pulls below are only defined when the pre-fit uncertainty exists, <em>nothing</em> will be reported for parameters that have no prior constraint (except in the case of the <code>unconstPullAsym</code> choice as described below). You may want to run without this option and <code>--all</code> to get information about those parameters.</p>
<ul>
<li>
<p><code>relDiffAsymErrs</code>: This is the same as the default output of the tool, except that only constrained parameters (i.e. where the pre-fit uncertainty is defined) are reported. The uncertainty is also reported and calculated as <span class="arithmatex">\(\sigma/\sigma_{I}\)</span>.</p>
</li>
<li>
<p><code>unconstPullAsym</code>: Report the pull as <span class="arithmatex">\(\frac{\nu-\nu_{I}}{\sigma}\)</span>, where <span class="arithmatex">\(\nu_{I}\)</span> and <span class="arithmatex">\(\sigma\)</span> are the initial value and <strong>post-fit</strong> uncertainty of that nuisance parameter. The pull defined in this way will have no error bar, but <em>all</em> nuisance parameters will have a result in this case.</p>
</li>
<li>
<p><code>compatAsym</code>: The pull is defined as <span class="arithmatex">\(\frac{\nu-\nu_{D}}{\sqrt{\sigma^{2}+\sigma_{D}^{2}}}\)</span>, where <span class="arithmatex">\(\nu_{D}\)</span> and <span class="arithmatex">\(\sigma_{D}\)</span> are calculated as <span class="arithmatex">\(\sigma_{D} = (\frac{1}{\sigma^{2}} - \frac{1}{\sigma_{I}^{2}})^{-1}\)</span> and <span class="arithmatex">\(\nu_{D} = \sigma_{D}(\nu - \frac{\nu_{I}}{\sigma_{I}^{2}})\)</span>. In this expression <span class="arithmatex">\(\nu_{I}\)</span> and <span class="arithmatex">\(\sigma_{I}\)</span> are the initial value and uncertainty of that nuisance parameter. This can be thought of as a <em>compatibility</em> between the initial measurement (prior) and an imagined measurement where only the data (with no constraint on the nuisance parameter) is used to measure the nuisance parameter. There is no error bar associated with this value.</p>
</li>
<li>
<p><code>diffPullAsym</code>: The pull is defined as <span class="arithmatex">\(\frac{\nu-\nu_{I}}{\sqrt{\sigma_{I}^{2}-\sigma^{2}}}\)</span>, where <span class="arithmatex">\(\nu_{I}\)</span> and <span class="arithmatex">\(\sigma_{I}\)</span> are the pre-fit value and uncertainty (from <a href="http://physics.rockefeller.edu/luc/technical_reports/cdf5776_pulls.pdf">L. Demortier and L. Lyons</a>). If the denominator is close to 0 or the post-fit uncertainty is larger than the pre-fit (usually due to some failure in the calculation), the pull is not defined and the result will be reported as <code>0 +/- 999</code>.</p>
</li>
</ul>
<p>If using <code>--pullDef</code>, the results for <em>all</em> parameters for which the pull can be calculated will be shown (i.e <code>--all</code> will be set to <code>true</code>), not just those that have moved by some metric.</p>
<p>This script has the option (<code>-g outputfile.root</code>) to produce plots of the fitted <em>values</em> of the nuisance parameters and their post-fit, asymmetric uncertainties. Instead, the pulls defined using one of the options above, can be plotted using the option <code>--pullDef X</code>. In addition this will produce a plot showing a comparison between the post-fit and pre-fit (symmetrized) uncertainties on the nuisance parameters.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>In the above options, if an asymmetric uncertainty is associated with the nuisance parameter, then the choice of which uncertainty is used in the definition of the pull will depend on the sign of <span class="arithmatex">\(\nu-\nu_{I}\)</span>.</p>
</div>
<h3 id="normalizations">Normalizations</h3>
<p>For a certain class of models, like those made from datacards for shape-based analysis, the tool can also compute and save the best fit yields of all processes to the output ROOT file. If this feature is turned on with the option <code>--saveNormalizations</code>, the file will also contain three <code>RooArgSet</code> objects <code>norm_prefit</code>, <code>norm_fit_s</code>, and <code>norm_fit_b</code>. These each contain one <code>RooConstVar</code> for each channel <code>xxx</code> and process <code>yyy</code> with name <strong><code>xxx/yyy</code></strong> and value equal to the best fit yield. You can use <code>RooRealVar::getVal</code> and <code>RooRealVar::getError</code> to estimate both the post-fit (or pre-fit) values and uncertainties of these normalizations.</p>
<p>The sample <code>pyROOT</code> macro <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/test/mlfitNormsToText.py">mlfitNormsToText.py</a> can be used to convert the ROOT file into a text table with four columns: channel, process, yield from the signal+background fit, and yield from the background-only fit. To include the uncertainties in the table, add the option <code>--uncertainties</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note that when running with multiple toys, the <code>norm_fit_s</code>, <code>norm_fit_b</code>, and <code>norm_prefit</code> objects will be stored for the <em>last</em> toy dataset generated and so may not be useful to you.</p>
</div>
<p>Note that this procedure works only for "extended likelihoods" like the ones used in shape-based analysis, not for counting experiment datacards. You can however convert a counting experiment datacard to an equivalent shape-based one by adding a line <code>shapes * * FAKE</code> in the datacard after the <code>imax</code>, <code>jmax</code>, <code>kmax</code> lines. Alternatively, you can use <code>combineCards.py countingcard.txt -S &gt; shapecard.txt</code> to do this conversion.</p>
<h4 id="per-bin-norms-for-shape-analyses">Per-bin norms for shape analyses</h4>
<p>If you have a shape-based analysis, you can include the option <code>--savePredictionsPerToy</code>. With this option, additional branches will be filled in the three output trees contained in <code>fitDiagnostics.root</code>.</p>
<p>The normalization values for each toy will be stored in the branches inside the <code>TTrees</code> named <strong>n_exp[_final]_binxxx_proc_yyy</strong>. The <strong>_final</strong> will only be there if there are systematic uncertainties affecting this process.</p>
<p>Additionally, there will be branches that provide the value of the expected <strong>bin</strong> content for each process, in each channel. These are named <strong>n_exp[_final]_binxxx_proc_yyy_i</strong> (where <strong>_final</strong> will only be in the name if there are systematic uncertainties affecting this process) for channel <code>xxx</code>, process <code>yyy</code>, bin number <code>i</code>. In the case of the post-fit trees (<code>tree_fit_s/b</code>), these will be the expectations from the <em>fitted</em> models, while for the pre-fit tree, they will be the expectation from the generated model (i.e if running toys with <code>-t N</code> and using <code>--genNuisances</code>, they will be randomized for each toy). These can be useful, for example, for calculating correlations/covariances between different bins, in different channels or processes, within the model from toys.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Be aware that for <em>unbinned</em> models, a binning scheme is adopted based on the <code>RooRealVar::getBinning</code> for the observable defining the shape, if it exists, or <span style="font-variant:small-caps;">Combine</span> will adopt some appropriate binning for each observable.</p>
</div>
<h3 id="plotting">Plotting</h3>
<p><code>FitDiagnostics</code> can also produce pre- and post-fit plots of the model along with the data. They will be stored in the same directory as <code>fitDiagnostics.root</code>. To obtain these, you have to specify the option <code>--plots</code>, and then <em>optionally specify</em> the names of the signal and background PDFs/templates, e.g. <code>--signalPdfNames='ggH*,vbfH*'</code> and <code>--backgroundPdfNames='*DY*,*WW*,*Top*'</code> (by default, the definitions of signal and background are taken from the datacard). For models with more than 1 observable, a separate projection onto each observable will be produced.</p>
<p>An alternative is to use the option <code>--saveShapes</code>. This will add additional folders in <code>fitDiagnostics.root</code> for each category, with pre- and post-fit distributions of the signals and backgrounds as TH1s, and the data as <code>TGraphAsymmErrors</code> (with Poisson intervals as error bars).</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you want to save post-fit shapes at a specific <strong>r</strong> value, add the options <code>--customStartingPoint</code> and <code>--skipSBFit</code>, and set the <strong>r</strong> value. The result will appear in <strong>shapes_fit_b</strong>, as described below.</p>
</div>
<p>Three additional folders (<strong>shapes_prefit</strong>, <strong>shapes_fit_sb</strong> and <strong>shapes_fit_b</strong> ) will contain the following distributions:</p>
<table>
<thead>
<tr>
<th>Object</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>data</code></strong></td>
<td><code>TGraphAsymmErrors</code> containing the observed data (or toy data if using <code>-t</code>). The vertical error bars correspond to the 68% interval for a Poisson distribution centered on the observed count (Garwood intervals), following the <a href="https://twiki.cern.ch/twiki/bin/view/CMS/PoissonErrorBars">recipe provided by the CMS Statistics Committee</a>.</td>
</tr>
<tr>
<td><strong><code>$PROCESS</code></strong> (id &lt;= 0)</td>
<td><code>TH1F</code> for each signal process in each channel, named as in the datacard</td>
</tr>
<tr>
<td><strong><code>$PROCESS</code></strong> (id &gt; 0)</td>
<td><code>TH1F</code> for each background process in each channel, named as in the datacard</td>
</tr>
<tr>
<td><strong><code>total_signal</code></strong></td>
<td><code>TH1F</code> Sum over the signal components</td>
</tr>
<tr>
<td><strong><code>total_background</code></strong></td>
<td><code>TH1F</code> Sum over the background components</td>
</tr>
<tr>
<td><strong><code>total</code></strong></td>
<td><code>TH1F</code> Sum over all of the signal and background components</td>
</tr>
</tbody>
</table>
<p>The above distributions are provided <em>for each channel included in the datacard</em>, in separate subfolders, named as in the datacard: There will be one subfolder per channel.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The pre-fit signal is evaluated for <code>r=1</code> by default, but this can be modified using the option <code>--preFitValue</code>.</p>
</div>
<p>The distributions and normalizations are guaranteed to give the correct interpretation:</p>
<ul>
<li>
<p>For shape datacards whose inputs are <code>TH1</code>, the histograms/data points will have the bin number as the x-axis and the content of each bin will be a number of events.</p>
</li>
<li>
<p>For datacards whose inputs are <code>RooAbsPdf</code>/<code>RooDataHist</code>s, the x-axis will correspond to the observable and the bin content will be the PDF density / events divided by the bin width. This means the absolute number of events in a given bin, i, can be obtained from <code>h.GetBinContent(i)*h.GetBinWidth(i)</code> or similar for the data graphs. <strong>Note</strong> that for <em>unbinned</em> analyses <span style="font-variant:small-caps;">Combine</span> will make a reasonable guess as to an appropriate binning.</p>
</li>
</ul>
<p>Uncertainties on the shapes will be added with the option <code>--saveWithUncertainties</code>. These uncertainties are generated by re-sampling of the fit covariance matrix, thereby accounting for the full correlation between the parameters of the fit.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It may be tempting to sum up the uncertainties in each bin (in quadrature) to get the <em>total</em> uncertainty on a process. However, this is (usually) incorrect, as doing so would not account for correlations <em>between the bins</em>. Instead you can refer to the uncertainties which will be added to the post-fit normalizations described above.</p>
</div>
<p>Additionally, the covariance matrix <strong>between</strong> bin yields (or yields/bin-widths) in each channel will also be saved as a <code>TH2F</code> named <strong>total_covar</strong>. If the covariance between <em>all bins</em> across <em>all channels</em> is desired, this can be added using the option <code>--saveOverallShapes</code>. Each folder will now contain additional distributions (and covariance matrices) corresponding to the concatenation of the bins in each channel (and therefore the covaraince between every bin in the analysis). The bin labels should make it clear as to which bin corresponds to which channel.</p>
<h3 id="toy-by-toy-diagnostics">Toy-by-toy diagnostics</h3>
<p><code>FitDiagnostics</code> can also be used to diagnose the fitting procedure in toy experiments to identify potentially problematic nuisance parameters when running the full limits/p-values. This can be done by adding the option <code>-t &lt;num toys&gt;</code>. The output file, <code>fitDiagnostics.root</code> the three <code>TTrees</code> will contain the value of the constraint fitted result in each toy, as a separate entry. It is recommended to use the following options when investigating toys to reduce the running time: <code>--toysFrequentist</code> <code>--noErrors</code> <code>--minos none</code></p>
<p>The results can be plotted using the macro <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/test/plotParametersFromToys.C">test/plotParametersFromToys.C</a></p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">-</span><span class="n">l</span>
<span class="p">.</span><span class="n">L</span><span class="w"> </span><span class="n">plotParametersFromToys</span><span class="p">.</span><span class="n">C</span><span class="o">+</span>
<span class="n">plotParametersFromToys</span><span class="p">(</span><span class="s">&quot;fitDiagnosticsToys.root&quot;</span><span class="p">,</span><span class="s">&quot;fitDiagnosticsData.root&quot;</span><span class="p">,</span><span class="s">&quot;workspace.root&quot;</span><span class="p">,</span><span class="s">&quot;r&lt;0&quot;</span><span class="p">)</span>
</code></pre></div>
<p>The first argument is the name of the output file from running with toys, and the second and third (optional) arguments are the name of the file containing the result from a fit to the data and the workspace (created from <code>text2workspace.py</code>). The fourth argument can be used to specify a cut string applied to one of the branches in the tree, which can be used to correlate strange behaviour with specific conditions. The output will be 2 pdf files (<strong><code>tree_fit_(s)b.pdf</code></strong>) and 2 ROOT files (<strong><code>tree_fit_(s)b.root</code></strong>) containing canvases of the fit results of the tool. For details on the output plots, consult <a href="http://cms.cern.ch/iCMS/user/noteinfo?cmsnoteid=CMS%20AN-2012/317">AN-2012/317</a>.</p>
<h2 id="scaling-constraints">Scaling constraints</h2>
<p>It possible to scale the <strong>constraints</strong> on the nuisance parameters when converting the datacard to a workspace (see the section on <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part2/physicsmodels/">physics models</a>) with <code>text2workspace.py</code>. This can be useful for projection studies of the analysis to higher luminosities or with different assumptions about the sizes of certain systematics without changing the datacard by hand.</p>
<p>We consider two kinds of scaling;</p>
<ul>
<li>A <em>constant scaling factor</em> to scale the constraints</li>
<li>A <em>functional scale factor</em> that depends on some other parameters in the workspace, eg a luminosity scaling parameter (as a <code>rateParam</code> affecting all processes).</li>
</ul>
<p>In both cases these scalings can be introduced by adding some extra options at the <code>text2workspace.py</code> step.</p>
<p>To add a <em>constant scaling factor</em> we use the option <code>--X-rescale-nuisance</code>, eg</p>
<pre><code>text2workspace.py datacard.txt --X-rescale-nuisance '[some regular expression]' 0.5
</code></pre>
<p>will create the workspace in which every nuisance parameter whose name matches the specified regular expression will have the width of the gaussian constraint scaled by a factor 0.5.</p>
<p>Multiple <code>--X-rescale-nuisance</code> options can be specified to set different scalings for different nuisances (note that you actually have to write <code>--X-rescale-nuisance</code> each time as in <code>--X-rescale-nuisance 'theory.*' 0.5  --X-rescale-nuisance 'exp.*' 0.1</code>).</p>
<p>To add a <em>functional scaling factor</em> we use the option <code>--X-nuisance-function</code>, which works in a similar way. Instead of a constant value you should specify a <code>RooFit</code> factory expression.</p>
<p>A typical case would be scaling by <span class="arithmatex">\(1/\sqrt{L}\)</span>, where <span class="arithmatex">\(L\)</span> is a luminosity scale factor. For example, assuming there is some parameter in the datacard/workspace called <strong><code>lumiscale</code></strong>,</p>
<pre><code>text2workspace.py datacard.txt --X-nuisance-function '[some regular expression]' 'expr::lumisyst("1/sqrt(@0)",lumiscale[1])'
</code></pre>
<p>This factory syntax is flexible, but for our use case the typical format will be: <code>expr::[function name]("[formula]", [arg0], [arg1], ...)</code>. The <code>arg0</code>, <code>arg1</code> ... are represented in the formula by <code>@0</code>, <code>@1</code>,... placeholders.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We are playing a slight trick here with the <code>lumiscale</code> parameter. At the point at which <code>text2workspace.py</code> is building these scaling terms the <code>lumiscale</code> for the <code>rateParam</code> has not yet been created. By writing <code>lumiscale[1]</code> we are telling RooFit to create this variable with an initial value of 1, and then later this will be re-used by the <code>rateParam</code> creation.</p>
</div>
<p>A similar option, <code>--X-nuisance-group-function</code>, can be used to scale whole groups of nuisances (see <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part2/settinguptheanalysis/#groups-of-nuisances">groups of nuisances</a>). Instead of a regular expression just give the group name instead,</p>
<pre><code>text2workspace.py datacard.txt --X-nuisance-group-function [group name] 'expr::lumisyst("1/sqrt(@0)",lumiscale[1])'
</code></pre>
<h2 id="nuisance-parameter-impacts">Nuisance parameter impacts</h2>
<p>The impact of a nuisance parameter (NP)  on a parameter of interest (POI)  is defined as the shift  that is induced as  is fixed and brought to its +1 or 1 post-fit values, with all other parameters profiled as normal (see <a href="https://link.springer.com/article/10.1007/JHEP01(2015)069">JHEP 01 (2015) 069</a> for a description of this method).</p>
<p>This is effectively a measure of the correlation between the NP and the POI, and is useful for determining which NPs have the largest effect on the POI uncertainty.</p>
<p>It is possible to use the <code>MultiDimFit</code> method of <span style="font-variant:small-caps;">Combine</span> with the option <code>--algo impact -P parameter</code> to calculate the impact of a particular nuisance parameter on the parameter(s) of interest. We will use the <code>combineTool.py</code> script to automate the fits.</p>
<p>We will use an example workspace from the <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/data/tutorials/htt/125/htt_tt.txt"><span class="arithmatex">\(H\rightarrow\tau\tau\)</span> datacard</a>,</p>
<div class="highlight"><pre><span></span><code>$ cp HiggsAnalysis/CombinedLimit/data/tutorials/htt/125/htt_tt.txt .
$ text2workspace.py htt_tt.txt -m 125
</code></pre></div>
<p>Calculating the impacts is done in a few stages. First we just fit for each POI, using the <code>--doInitialFit</code> option with <code>combineTool.py</code>, and adding the <code>--robustFit 1</code> option that will be passed through to <span style="font-variant:small-caps;">Combine</span>,</p>
<pre><code>combineTool.py -M Impacts -d htt_tt.root -m 125 --doInitialFit --robustFit 1
</code></pre>
<p>Have a look at the options as for <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/commonstatsmethods/#useful-options-for-likelihood-scans">likelihood scans</a> when using <code>robustFit 1</code>.</p>
<p>Next we perform a similar scan for each nuisance parameter with the <code>--doFits</code> options,</p>
<pre><code>combineTool.py -M Impacts -d htt_tt.root -m 125 --robustFit 1 --doFits
</code></pre>
<p>Note that this will run approximately 60 scans, and to speed things up the option <code>--parallel X</code> can be given to run X <span style="font-variant:small-caps;">Combine</span> jobs simultaneously. The batch and grid submission methods described in the <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/runningthetool/#combinetool-for-job-submission">combineTool for job submission</a> section can also be used.</p>
<p>Once all jobs are completed, the output can be collected and written into a json file:</p>
<pre><code>combineTool.py -M Impacts -d htt_tt.root -m 125 -o impacts.json
</code></pre>
<p>A plot summarizing the nuisance parameter values and impacts can be made with <code>plotImpacts.py</code>,</p>
<pre><code>plotImpacts.py -i impacts.json -o impacts
</code></pre>
<p>The first page of the output is shown below. Note that in these figures, the nuisance parameters are labelled as <span class="arithmatex">\(\theta\)</span> instead of <span class="arithmatex">\(\nu\)</span>.</p>
<p><img alt="" src="../images/impacts.png" /></p>
<p>The direction of the +1 and -1 impacts (i.e. when the NP is moved to its +1 or -1 values) on the POI indicates whether the parameter is correlated or anti-correlated with it.</p>
<p>For models with multiple POIs, the <span style="font-variant:small-caps;">Combine</span> option <code>--redefineSignalPOIs X,Y,Z...</code> should be specified in all three of the <code>combineTool.py -M Impacts [...]</code> steps above. The final step will produce the <code>impacts.json</code> file which will contain the impacts for all the specified POIs. In the <code>plotImpacts.py</code> script, a particular POI can be specified with <code>--POI X</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The plot also shows the <em>best fit</em> value of the POI at the top and its uncertainty. You may wish to allow the range to go negative (i.e using <code>--setParameterRanges</code> or <code>--rMin</code>) to avoid getting one-sided impacts!</p>
</div>
<p>This script also accepts an optional json-file argument with <code>-t</code>, which can be used to provide a dictionary for renaming parameters. A simple example would be to create a file <code>rename.json</code>,</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="s2">&quot;r&quot;</span> <span class="p">:</span> <span class="s2">&quot;#mu&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>that will rename the POI label on the plot.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Since <code>combineTool</code> accepts the usual options for combine you can also generate the impacts on an Asimov or toy dataset.</p>
</div>
<p>The left panel in the summary plot shows the value of <span class="arithmatex">\((\nu-\nu_{0})/\Delta_{\nu}\)</span> where <span class="arithmatex">\(\nu\)</span> and <span class="arithmatex">\(\nu_{0}\)</span> are the <strong>post</strong> and <strong>pre</strong>-fit values of the nuisance parameter and <span class="arithmatex">\(\Delta_{\nu}\)</span> is the <strong>pre</strong>-fit uncertainty. The asymmetric error bars show the <strong>post</strong>-fit uncertainty divided by the <strong>pre</strong>-fit uncertainty meaning that parameters with error bars smaller than <span class="arithmatex">\(\pm 1\)</span> are constrained in the fit. The pull will additionally be shown. As with the <code>diffNuisances.py</code> script, the option <code>--pullDef</code> can be used (to modify the definition of the <em>pull</em> that is shown).</p>
<h2 id="breakdown-of-uncertainties">Breakdown of uncertainties</h2>
<p>Often you will want to report the breakdown of your total (systematic) uncertainty on a measured parameter due to one or more groups of nuisance parameters. For example, these groups could be theory uncertainties, trigger uncertainties, ... The prodecude to do this in <span style="font-variant:small-caps;">Combine</span> is to sequentially freeze groups of nuisance parameters and subtract (in quadrature) from the total uncertainty. Below are the steps to do so. We will use the <code>data/tutorials/htt/125/htt_tt.txt</code> datacard for this.</p>
<ol>
<li>Add groups to the datacard to group nuisance parameters. Nuisance parameters not in groups will be considered as "rest" in the later steps. The lines should look like the following and you should add them to the end of the datacard</li>
</ol>
<div class="highlight"><pre><span></span><code>theory      group = QCDscale_VH QCDscale_ggH1in QCDscale_ggH2in QCDscale_qqH UEPS pdf_gg pdf_qqbar
calibration group = CMS_scale_j_8TeV CMS_scale_t_tautau_8TeV CMS_htt_scale_met_8TeV
efficiency  group = CMS_eff_b_8TeV   CMS_eff_t_tt_8TeV CMS_fake_b_8TeV
</code></pre></div>
<ol>
<li>
<p>Create the workspace with <code>text2workspace.py data/tutorials/htt/125/htt_tt.txt -m 125</code>.</p>
</li>
<li>
<p>Run a fit with all nuisance parameters floating and store the workspace in an output file - <code>combine data/tutorials/htt/125/htt_tt.root -M MultiDimFit --saveWorkspace -n htt.postfit</code></p>
</li>
<li>
<p>Run a scan from the postfit workspace</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>combine higgsCombinehtt.postfit.MultiDimFit.mH120.root -M MultiDimFit -n htt.total --algo grid --snapshotName MultiDimFit --setParameterRanges r=0,4
</code></pre></div>
<ol>
<li>Run additional scans using the post-fit workspace, sequentially adding another group to the list of groups to freeze</li>
</ol>
<div class="highlight"><pre><span></span><code>combine higgsCombinehtt.postfit.MultiDimFit.mH120.root -M MultiDimFit --algo grid --snapshotName MultiDimFit --setParameterRanges r=0,4  --freezeNuisanceGroups theory -n htt.freeze_theory

combine higgsCombinehtt.postfit.MultiDimFit.mH120.root -M MultiDimFit --algo grid --snapshotName MultiDimFit --setParameterRanges r=0,4  --freezeNuisanceGroups theory,calibration -n htt.freeze_theory_calibration

combine higgsCombinehtt.postfit.MultiDimFit.mH120.root -M MultiDimFit --algo grid --snapshotName MultiDimFit --setParameterRanges r=0,4  --freezeNuisanceGroups theory,calibration,efficiency -n htt.freeze_theory_calibration_efficiency
</code></pre></div>
<ol>
<li>Run one last scan freezing all of the constrained nuisance parameters (this represents the statistical uncertainty only).</li>
</ol>
<div class="highlight"><pre><span></span><code>combine higgsCombinehtt.postfit.MultiDimFit.mH120.root -M MultiDimFit --algo grid --snapshotName MultiDimFit --setParameterRanges r=0,4  --freezeParameters allConstrainedNuisances -n htt.freeze_all
</code></pre></div>
<ol>
<li>Use the <code>combineTool</code> script <code>plot1DScan.py</code> to report the breakdown of uncertainties.</li>
</ol>
<div class="highlight"><pre><span></span><code>plot1DScan.py higgsCombinehtt.total.MultiDimFit.mH120.root --main-label &quot;Total Uncert.&quot;  --others higgsCombinehtt.freeze_theory.MultiDimFit.mH120.root:&quot;freeze theory&quot;:4 higgsCombinehtt.freeze_theory_calibration.MultiDimFit.mH120.root:&quot;freeze theory+calibration&quot;:7 higgsCombinehtt.freeze_theory_calibration_efficiency.MultiDimFit.mH120.root:&quot;freeze theory+calibration+efficiency&quot;:2 higgsCombinehtt.freeze_all.MultiDimFit.mH120.root:&quot;stat only&quot;:6  --output breakdown --y-max 10 --y-cut 40 --breakdown &quot;theory,calibration,efficiency,rest,stat&quot;
</code></pre></div>
<p>The final step calculates the contribution of each group of nuisance parameters as the subtraction in quadrature of each scan from the previous one. This procedure guarantees that the sum in quadrature of the individual components is the same as the total uncertainty.</p>
<p>The plot below is produced,</p>
<p><img alt="" src="../images/breakdown.png" /></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While the above procedure is guaranteed the have the effect that the sum in quadrature of the breakdown will equal the total uncertainty, the order in which you freeze the groups can make a difference due to correlations induced by the fit. You should check if the answers change significantly if changing the order and we recommend you start with the largest group (in terms of overall contribution to the uncertainty) first, working down the list in order of the size of the contribution.</p>
</div>
<h2 id="channel-masking">Channel Masking</h2>
<p>The <span style="font-variant:small-caps;">Combine</span> tool has a number of features for diagnostics and plotting results of fits. It can often be useful to turn off particular channels in a combined analysis to see how constraints/shifts in parameter values can vary. It can also be helpful to plot the post-fit shapes and uncertainties of a particular channel (for example a signal region) <em>without</em> including the constraints from the data in that region.</p>
<p>This can in some cases be achieved by removing a specific datacard when running <code>combineCards.py</code>. However, when doing so, the information of particular nuisance parameters and PDFs in that region will be lost. Instead, it is possible to <strong><em>mask</em></strong> that channel from the likelihood. This is achieved at the <code>text2Workspace</code> step using the option <code>--channel-masks</code>.</p>
<h3 id="example-removing-constraints-from-the-signal-region">Example: removing constraints from the signal region</h3>
<p>We will take the control region example from the rate parameters tutorial from <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/tree/81x-root606/data/tutorials/rate_params">data/tutorials/rate_params/</a>.</p>
<p>The first step is to combine the cards
combineCards.py signal=signal_region.txt dimuon=dimuon_control_region.txt singlemuon=singlemuon_control_region.txt &gt; datacard.txt</p>
<p>Note that we use the directive <code>CHANNELNAME=CHANNEL_DATACARD.txt</code> so that the names of the channels are under our control and easier to interpret. Next, we make a workspace and tell <span style="font-variant:small-caps;">Combine</span> to create the parameters used to <em>mask channels</em></p>
<pre><code>text2workspace.py datacard.txt --channel-masks
</code></pre>
<p>Now we will try to do a fit <em>ignoring</em> the signal region. We can turn off the signal region by setting the corresponding channel mask parameter to 1: <code>--setParameters mask_signal=1</code>. Note that <code>text2workspace</code> has created a masking parameter for every channel with the naming scheme <strong>mask_CHANNELNAME</strong>. By default, every parameter is set to 0 so that the channel is unmasked by default.</p>
<pre><code>combine datacard.root -M FitDiagnostics --saveShapes --saveWithUncertainties --setParameters mask_signal=1
</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There will be a lot of warnings from <span style="font-variant:small-caps;">Combine</span>. These are safe to ignore as they are due to the s+b fit not converging. This is expected as the free signal parameter cannot be constrained because the data in the signal region is being ignored.</p>
</div>
<p>We can compare the post-fit background and uncertainties with and without the signal region included by re-running with <code>--setParameters mask_signal=0</code> (or just removing that option completely). Below is a comparison of the background in the signal region with and without masking the data in the signal region. We take these from the shapes folder
<strong>shapes_fit_b/signal/total_background</strong> in the <code>fitDiagnostics.root</code> output.</p>
<p><img alt="" src="../images/masking_tutorial.png" /></p>
<p>Clearly the background shape is different and much less constrained <em>without including the signal region</em>, as expected. Channel masking can be used with <em>any method</em> in <span style="font-variant:small-caps;">Combine</span>.</p>
<h2 id="roomultipdf-conventional-bias-studies">RooMultiPdf conventional bias studies</h2>
<p>Several analyses in CMS use a functional form to describe the background. This functional form is fit to the data. Often however, there is some uncertainty associated with the choice of which background function to use, and this choice will impact the fit results. It is therefore often the case that in these analyses, a bias study is performed. This study will give an indication of the size of the potential bias in the result, given a certain choice of functional form. These studies can be conducted using <span style="font-variant:small-caps;">Combine</span>.</p>
<p>Below is an example script that will produce a workspace based on a simplified Higgs to diphoton (Hgg) analysis with a <em>single</em> category. It will produce the data and PDFs necessary for this example, and you can use it as a basis to construct your own studies.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">makeRooMultiPdfWorkspace</span><span class="p">(){</span>

<span class="w">   </span><span class="c1">// Load the combine Library</span>
<span class="w">   </span><span class="n">gSystem</span><span class="o">-&gt;</span><span class="n">Load</span><span class="p">(</span><span class="s">&quot;libHiggsAnalysisCombinedLimit.so&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// mass variable</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">mass</span><span class="p">(</span><span class="s">&quot;CMS_hgg_mass&quot;</span><span class="p">,</span><span class="s">&quot;m_{#gamma#gamma}&quot;</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">180</span><span class="p">);</span>


<span class="w">   </span><span class="c1">// create 3 background pdfs</span>
<span class="w">   </span><span class="c1">// 1. exponential</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">expo_1</span><span class="p">(</span><span class="s">&quot;expo_1&quot;</span><span class="p">,</span><span class="s">&quot;slope of exponential&quot;</span><span class="p">,</span><span class="mf">-0.02</span><span class="p">,</span><span class="mf">-0.1</span><span class="p">,</span><span class="mf">-0.0001</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooExponential</span><span class="w"> </span><span class="n">exponential</span><span class="p">(</span><span class="s">&quot;exponential&quot;</span><span class="p">,</span><span class="s">&quot;exponential pdf&quot;</span><span class="p">,</span><span class="n">mass</span><span class="p">,</span><span class="n">expo_1</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// 2. polynomial with 2 parameters</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">poly_1</span><span class="p">(</span><span class="s">&quot;poly_1&quot;</span><span class="p">,</span><span class="s">&quot;T1 of chebychev polynomial&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">-3</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">poly_2</span><span class="p">(</span><span class="s">&quot;poly_2&quot;</span><span class="p">,</span><span class="s">&quot;T2 of chebychev polynomial&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">-3</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooChebychev</span><span class="w"> </span><span class="n">polynomial</span><span class="p">(</span><span class="s">&quot;polynomial&quot;</span><span class="p">,</span><span class="s">&quot;polynomial pdf&quot;</span><span class="p">,</span><span class="n">mass</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">poly_1</span><span class="p">,</span><span class="n">poly_2</span><span class="p">));</span>

<span class="w">   </span><span class="c1">// 3. A power law function</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">pow_1</span><span class="p">(</span><span class="s">&quot;pow_1&quot;</span><span class="p">,</span><span class="s">&quot;exponent of power law&quot;</span><span class="p">,</span><span class="mi">-3</span><span class="p">,</span><span class="mi">-6</span><span class="p">,</span><span class="mf">-0.0001</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooGenericPdf</span><span class="w"> </span><span class="n">powerlaw</span><span class="p">(</span><span class="s">&quot;powerlaw&quot;</span><span class="p">,</span><span class="s">&quot;TMath::Power(@0,@1)&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span><span class="n">pow_1</span><span class="p">));</span>

<span class="w">   </span><span class="c1">// Generate some data (lets use the power lay function for it)</span>
<span class="w">   </span><span class="c1">// Here we are using unbinned data, but binning the data is also fine</span>
<span class="w">   </span><span class="n">RooDataSet</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">powerlaw</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">NumEvents</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>

<span class="w">   </span><span class="c1">// First we fit the pdfs to the data (gives us a sensible starting value of parameters for, e.g - blind limits)</span>
<span class="w">   </span><span class="n">exponential</span><span class="p">.</span><span class="n">fitTo</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span><span class="w">   </span><span class="c1">// index 0</span>
<span class="w">   </span><span class="n">polynomial</span><span class="p">.</span><span class="n">fitTo</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span><span class="w">   </span><span class="c1">// index 1</span>
<span class="w">   </span><span class="n">powerlaw</span><span class="p">.</span><span class="n">fitTo</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span><span class="w">     </span><span class="c1">// index 2</span>

<span class="w">   </span><span class="c1">// Make a plot (data is a toy dataset)</span>
<span class="w">   </span><span class="n">RooPlot</span><span class="w"> </span><span class="o">*</span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mass</span><span class="p">.</span><span class="n">frame</span><span class="p">();</span><span class="w">   </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">plotOn</span><span class="p">(</span><span class="n">plot</span><span class="p">);</span>
<span class="w">   </span><span class="n">exponential</span><span class="p">.</span><span class="n">plotOn</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">LineColor</span><span class="p">(</span><span class="n">kGreen</span><span class="p">));</span>
<span class="w">   </span><span class="n">polynomial</span><span class="p">.</span><span class="n">plotOn</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">LineColor</span><span class="p">(</span><span class="n">kBlue</span><span class="p">));</span>
<span class="w">   </span><span class="n">powerlaw</span><span class="p">.</span><span class="n">plotOn</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">LineColor</span><span class="p">(</span><span class="n">kRed</span><span class="p">));</span>
<span class="w">   </span><span class="n">plot</span><span class="o">-&gt;</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&quot;PDF fits to toy data&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">plot</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">();</span>

<span class="w">   </span><span class="c1">// Make a RooCategory object. This will control which of the pdfs is &quot;active&quot;</span>
<span class="w">   </span><span class="n">RooCategory</span><span class="w"> </span><span class="n">cat</span><span class="p">(</span><span class="s">&quot;pdf_index&quot;</span><span class="p">,</span><span class="s">&quot;Index of Pdf which is active&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// Make a RooMultiPdf object. The order of the pdfs will be the order of their index, ie for below</span>
<span class="w">   </span><span class="c1">// 0 == exponential</span>
<span class="w">   </span><span class="c1">// 1 == polynomial</span>
<span class="w">   </span><span class="c1">// 2 == powerlaw</span>
<span class="w">   </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">mypdfs</span><span class="p">;</span>
<span class="w">   </span><span class="n">mypdfs</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">exponential</span><span class="p">);</span>
<span class="w">   </span><span class="n">mypdfs</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">polynomial</span><span class="p">);</span>
<span class="w">   </span><span class="n">mypdfs</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">);</span>

<span class="w">   </span><span class="n">RooMultiPdf</span><span class="w"> </span><span class="n">multipdf</span><span class="p">(</span><span class="s">&quot;roomultipdf&quot;</span><span class="p">,</span><span class="s">&quot;All Pdfs&quot;</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">mypdfs</span><span class="p">);</span>
<span class="w">   </span><span class="c1">// By default the multipdf will tell combine to add 0.5 to the nll for each parameter (this is the penalty for the discrete profiling method)</span>
<span class="w">   </span><span class="c1">// It can be changed with</span>
<span class="w">   </span><span class="c1">//   multipdf.setCorrectionFactor(penalty)</span>
<span class="w">   </span><span class="c1">// For bias-studies, this isn;t relevant however, so lets just leave the default</span>

<span class="w">   </span><span class="c1">// As usual make an extended term for the background with _norm for freely floating yield</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">norm</span><span class="p">(</span><span class="s">&quot;roomultipdf_norm&quot;</span><span class="p">,</span><span class="s">&quot;Number of background events&quot;</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// We will also produce a signal model for the bias studies</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">sigma</span><span class="p">(</span><span class="s">&quot;sigma&quot;</span><span class="p">,</span><span class="s">&quot;sigma&quot;</span><span class="p">,</span><span class="mf">1.2</span><span class="p">);</span><span class="w"> </span><span class="n">sigma</span><span class="p">.</span><span class="n">setConstant</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">MH</span><span class="p">(</span><span class="s">&quot;MH&quot;</span><span class="p">,</span><span class="s">&quot;MH&quot;</span><span class="p">,</span><span class="mi">125</span><span class="p">);</span><span class="w"> </span><span class="n">MH</span><span class="p">.</span><span class="n">setConstant</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooGaussian</span><span class="w"> </span><span class="n">signal</span><span class="p">(</span><span class="s">&quot;signal&quot;</span><span class="p">,</span><span class="s">&quot;signal&quot;</span><span class="p">,</span><span class="n">mass</span><span class="p">,</span><span class="n">MH</span><span class="p">,</span><span class="n">sigma</span><span class="p">);</span>


<span class="w">   </span><span class="c1">// Save to a new workspace</span>
<span class="w">   </span><span class="n">TFile</span><span class="w"> </span><span class="o">*</span><span class="n">fout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TFile</span><span class="p">(</span><span class="s">&quot;workspace.root&quot;</span><span class="p">,</span><span class="s">&quot;RECREATE&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooWorkspace</span><span class="w"> </span><span class="n">wout</span><span class="p">(</span><span class="s">&quot;workspace&quot;</span><span class="p">,</span><span class="s">&quot;workspace&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">norm</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">multipdf</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">signal</span><span class="p">);</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span>
<span class="w">   </span><span class="n">wout</span><span class="p">.</span><span class="n">Write</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>The signal is modelled as a simple Gaussian with a width approximately that of the diphoton resolution. For the background there is a choice of 3 functions: an exponential, a power-law, and a 2nd order polynomial. This choice is accessible within <span style="font-variant:small-caps;">Combine</span> through the use of the <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/interface/RooMultiPdf.h">RooMultiPdf</a> object, which can switch between the functions by setting their associated indices (herein called <strong>pdf_index</strong>). This (as with all parameters in <span style="font-variant:small-caps;">Combine</span>) can be set via the <code>--setParameters</code> option.</p>
<p>To assess the bias, one can throw toys using one function and fit with another. To do this, only a single datacard is needed: <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/tree/main/data/tutorials/bias_studies/hgg_toy_datacard.txt">hgg_toy_datacard.txt</a>.</p>
<p>The bias studies are performed in two stages. The first is to generate toys using one of the functions, under some value of the signal strength <strong>r</strong> (or <span class="arithmatex">\(\mu\)</span>). This can be repeated for several values of <strong>r</strong> and also at different masses, but in this example the Higgs boson mass is fixed to 125 GeV.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>combine<span class="w"> </span>hgg_toy_datacard.txt<span class="w"> </span>-M<span class="w"> </span>GenerateOnly<span class="w"> </span>--setParameters<span class="w"> </span><span class="nv">pdf_index</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>--toysFrequentist<span class="w"> </span>-t<span class="w"> </span><span class="m">100</span><span class="w"> </span>--expectSignal<span class="w"> </span><span class="m">1</span><span class="w"> </span>--saveToys<span class="w"> </span>-m<span class="w"> </span><span class="m">125</span><span class="w"> </span>--freezeParameters<span class="w"> </span>pdf_index
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to freeze <code>pdf_index</code>, otherwise <span style="font-variant:small-caps;">Combine</span> will try to iterate over the index in the frequentist fit.</p>
</div>
<p>Now we have 100 toys which, by setting <code>pdf_index=0</code>, sets the background PDF to the exponential function. This means we assume that the exponential is the <em>true</em> function. Note that the option <code>--toysFrequentist</code> is added; this first performs a fit of the PDF, assuming a signal strength of 1, to the data before generating the toys. This is the most obvious choice as to where to throw the toys from.</p>
<p>The next step is to fit the toys under a different background PDF hypothesis. This time we set the <code>pdf_index</code> to 1, which selects the powerlaw, and run fits with the <code>FitDiagnostics</code> method, again freezing <code>pdf_index</code>.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>combine<span class="w"> </span>hgg_toy_datacard.txt<span class="w"> </span>-M<span class="w"> </span>FitDiagnostics<span class="w">  </span>--setParameters<span class="w"> </span><span class="nv">pdf_index</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>--toysFile<span class="w"> </span>higgsCombineTest.GenerateOnly.mH125.123456.root<span class="w">  </span>-t<span class="w"> </span><span class="m">100</span><span class="w"> </span>--rMin<span class="w"> </span>-10<span class="w"> </span>--rMax<span class="w"> </span><span class="m">10</span><span class="w"> </span>--freezeParameters<span class="w"> </span>pdf_index<span class="w"> </span>--cminDefaultMinimizerStrategy<span class="o">=</span><span class="m">0</span>
</code></pre></div>
<p>Note how we add the option <code>--cminDefaultMinimizerStrategy=0</code>. This is because we do not need the Hessian, as <code>FitDiagnostics</code> will run MINOS to get the uncertainty on <code>r</code>. If we do not do this, Minuit will think the fit failed as we have parameters (those not attached to the current PDF) for which the likelihood is flat.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You may get warnings about non-accurate errors such as <code>[WARNING]: Unable to determine uncertainties on all fit parameters in b-only fit</code> - These can be ignored since they are related to the free parameters of the background PDFs which are not active.</p>
</div>
<p>In the output file <code>fitDiagnostics.root</code> there is a tree that contains the best fit results under the signal+background hypothesis. One measure of the bias is the <em>pull</em> defined as the difference between the measured value of <span class="arithmatex">\(\mu\)</span> and the generated value (here we used 1) relative to the uncertainty on <span class="arithmatex">\(\mu\)</span>. The pull distribution can be drawn and the mean provides an estimate of the pull. In this example, we are averaging the positive and negative uncertainties, but we could do something smarter if the uncertainties are very asymmetric.</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">fitDiagnostics</span><span class="p">.</span><span class="n">root</span>
<span class="n">tree_fit_sb</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">(</span><span class="s">&quot;(r-1)/(0.5*(rHiErr+rLoErr))&gt;&gt;h(20,-5,5)&quot;</span><span class="p">)</span>
<span class="n">h</span><span class="o">-&gt;</span><span class="n">Fit</span><span class="p">(</span><span class="s">&quot;gaus&quot;</span><span class="p">)</span>
</code></pre></div>
<p><img alt="" src="../images/biasexample.png" /></p>
<p>From the fitted Gaussian, we see the mean is at -1.29, which would indicate a bias of 129% of the uncertainty on mu from choosing the polynomial when the true function is an exponential.</p>
<h3 id="discrete-profiling">Discrete profiling</h3>
<p>If the <code>discrete</code> nuisance is left floating, it will be profiled by looping through the possible index values and finding the PDF that gives the best fit. This allows for the <a href="https://arxiv.org/pdf/1408.6865.pdf"><strong>discrete profiling method</strong></a> to be applied for any method which involves a profiled likelihood (frequentist methods).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should be careful since MINOS knows nothing about the discrete nuisances and hence estimations of uncertainties will be incorrect via MINOS. Instead, uncertainties from scans and limits will correctly account for these nuisance parameters. Currently the Bayesian methods will <em>not</em> properly treat the nuisance parameters, so some care should be taken when interpreting Bayesian results.</p>
</div>
<p>As an example, we can peform a likelihood scan as a function of the Higgs boson signal strength in the toy Hgg datacard. By leaving the object <code>pdf_index</code> non-constant, at each point in the likelihood scan, the PDFs will be iterated over and the one that gives the lowest -2 times log-likelihood, including the correction factor <span class="arithmatex">\(c\)</span> (as defined in the paper linked above) will be stored in the output tree. We can also check the scan when we fix at each PDF individually to check that the envelope is achieved. For this, you will need to include the option <code>--X-rtd REMOVE_CONSTANT_ZERO_POINT=1</code>. In this way, we can take a look at the absolute value to compare the curves, if we also include <code>--saveNLL</code>.</p>
<p>For example for a full scan, you can run</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>-d<span class="w"> </span>hgg_toy_datacard.txt<span class="w"> </span>--algo<span class="w"> </span>grid<span class="w"> </span>--setParameterRanges<span class="w"> </span><span class="nv">r</span><span class="o">=</span>-1,3<span class="w"> </span>--cminDefaultMinimizerStrategy<span class="w"> </span><span class="m">0</span><span class="w"> </span>--saveNLL<span class="w"> </span>-n<span class="w"> </span>Envelope<span class="w"> </span>-m<span class="w"> </span><span class="m">125</span><span class="w"> </span>--setParameters<span class="w"> </span><span class="nv">myIndex</span><span class="o">=</span>-1<span class="w"> </span>--X-rtd<span class="w"> </span><span class="nv">REMOVE_CONSTANT_ZERO_POINT</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>
<p>and for the individual <code>pdf_index</code> set to <code>X</code>,</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>-d<span class="w"> </span>hgg_toy_datacard.txt<span class="w"> </span>--algo<span class="w"> </span>grid<span class="w"> </span>--setParameterRanges<span class="w"> </span><span class="nv">r</span><span class="o">=</span>-1,3<span class="w"> </span>--cminDefaultMinimizerStrategy<span class="w"> </span><span class="m">0</span><span class="w"> </span>--saveNLL<span class="w"> </span>--freezeParameters<span class="w"> </span>pdf_index<span class="w"> </span>--setParameters<span class="w"> </span><span class="nv">pdf_index</span><span class="o">=</span>X<span class="w"> </span>-n<span class="w"> </span>fixed_pdf_X<span class="w"> </span>-m<span class="w"> </span><span class="m">125</span><span class="w"> </span>--X-rtd<span class="w"> </span><span class="nv">REMOVE_CONSTANT_ZERO_POINT</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>
<p>for <code>X=0,1,2</code></p>
<p>You can then plot the value of <code>2*(deltaNLL+nll+nll0)</code> to plot the absolute value of (twice) the negative log-likelihood, including the correction term for extra parameters in the different PDFs.</p>
<p>The above output will produce the following scans.
<img alt="" src="../images/discrete_profile.png" /></p>
<p>As expected, the curve obtained by allowing the <code>pdf_index</code> to float (labelled "Envelope") picks out the best function (maximum corrected likelihood) for each value of the signal strength.</p>
<p>In general, the performance of <span style="font-variant:small-caps;">Combine</span> can be improved when using the discrete profiling method by including the option <code>--X-rtd MINIMIZER_freezeDisassociatedParams</code>. This will stop parameters not associated to the current PDF from floating in the fits. Additionally, you can include the following options:</p>
<ul>
<li><code>--X-rtd MINIMIZER_multiMin_hideConstants</code>: hide the constant terms in the likelihood when recreating the minimizer</li>
<li><code>--X-rtd MINIMIZER_multiMin_maskConstraints</code>: hide the constraint terms during the discrete minimization process</li>
<li><code>--X-rtd MINIMIZER_multiMin_maskChannels=&lt;choice&gt;</code> mask the channels that are not needed from the NLL:</li>
<li><code>&lt;choice&gt; 1</code>: keeps unmasked all channels that are participating in the discrete minimization.</li>
<li><code>&lt;choice&gt; 2</code>: keeps unmasked only the channel whose index is being scanned at the moment.</li>
</ul>
<p>You may want to check with the <span style="font-variant:small-caps;">Combine</span> development team if you are using these options, as they are somewhat for <em>expert</em> use.</p>
<h2 id="roosplinend-multidimensional-splines">RooSplineND multidimensional splines</h2>
<p><a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/interface/RooSplineND.h">RooSplineND</a> can be used to interpolate from a tree of points to produce a continuous function in N-dimensions. This function can then be used as input to workspaces allowing for parametric rates/cross-sections/efficiencies. It can also be used to up-scale the resolution of likelihood scans (i.e like those produced from <span style="font-variant:small-caps;">Combine</span>) to produce smooth contours.</p>
<p>The spline makes use of a radial basis decomposition to produce a continous <span class="arithmatex">\(N \to 1\)</span> map (function) from <span class="arithmatex">\(M\)</span> provided sample points. The function of the <span class="arithmatex">\(N\)</span> variables <span class="arithmatex">\(\vec{x}\)</span>
is assumed to be of the form,</p>
<div class="arithmatex">\[
f(\vec{x}) = \sum_{i=1}^{M}w_{i}\phi(||\vec{x}-\vec{x}_{i}||),
\]</div>
<p>where <span class="arithmatex">\(\phi(||\vec{z}||) = e^{-\frac{||\vec{z}||}{\epsilon^{2}}}\)</span>. The distance <span class="arithmatex">\(||.||\)</span> between two points is given by,</p>
<div class="arithmatex">\[
||\vec{x}-\vec{y}||  = \sum_{j=1}^{N}(x_{j}-y_{j})^{2},
\]</div>
<p>if the option <code>rescale=false</code> and,</p>
<div class="arithmatex">\[
||\vec{x}-\vec{y}||  = \sum_{j=1}^{N} M^{1/N} \cdot \left( \frac{ x_{j}-y_{j} }{ \mathrm{max_{i=1,M}}(x_{i,j})-\mathrm{min_{i=1,M}}(x_{i,j}) }\right)^{2},
\]</div>
<p>if the option <code>rescale=true</code>. Given the sample points, it is possible to determine the weights <span class="arithmatex">\(w_{i}\)</span> as the solution of the set of equations,</p>
<div class="arithmatex">\[
\sum_{i=1}^{M}w_{i}\phi(||\vec{x}_{j}-\vec{x}_{i}||) = f(\vec{x}_{j}).
\]</div>
<p>The solution is obtained using the <code>eigen</code> c++ package.</p>
<p>The typical constructor of the object is as follows;</p>
<div class="highlight"><pre><span></span><code><span class="n">RooSplineND</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">RooArgList</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="n">TTree</span><span class="w"> </span><span class="o">*</span><span class="n">tree</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">fName</span><span class="o">=</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">eps</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">rescale</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">cutstring</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
</code></pre></div>
<p>where the arguments are:</p>
<ul>
<li><code>vars</code>: A <code>RooArgList</code> of <code>RooRealVars</code> representing the <span class="arithmatex">\(N\)</span> dimensions of the spline. The length of this list determines the dimension <span class="arithmatex">\(N\)</span> of the spline.</li>
<li><code>tree</code>: a TTree pointer where each entry represents a sample point used to construct the spline. The branch names must correspond to the names of the variables in <code>vars</code>.</li>
<li><code>fName</code>: is a string representing the name of the branch to interpret as the target function <span class="arithmatex">\(f\)</span>.</li>
<li><code>eps</code> : is the value of <span class="arithmatex">\(\epsilon\)</span> and represents the <em>width</em> of the basis functions <span class="arithmatex">\(\phi\)</span>.</li>
<li><code>rescale</code> : is an option to rescale the input sample points so that each variable has roughly the same range (see above in the definition of <span class="arithmatex">\(||.||\)</span>).</li>
<li><code>cutstring</code> : a string to remove sample points from the tree. Can be any typical cut string (eg "var1&gt;10 &amp;&amp; var2&lt;3").</li>
</ul>
<p>The object can be treated as a <code>RooAbsArg</code>; its value for the current values of the parameters is obtained as usual by using the <code>getVal()</code> method.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should not include more variable branches than contained in <code>vars</code> in the tree, as the spline will interpret them as additional sample points. You will get a warning if there are two <em>nearby</em> points in the input samples and this will cause a failure in determining the weights. If you cannot create a reduced tree, you can remove entries by using the <code>cutstring</code>.</p>
</div>
<p>The following script is an example that produces a 2D spline (<code>N=2</code>) from a set of 400 points (<code>M=400</code>) generated from a function.</p>
<details>
<summary><b>Show script</b></summary>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">splinend</span><span class="p">(){</span>
<span class="w">   </span><span class="c1">// library containing the RooSplineND</span>
<span class="w">   </span><span class="n">gSystem</span><span class="o">-&gt;</span><span class="n">Load</span><span class="p">(</span><span class="s">&quot;libHiggsAnalysisCombinedLimit.so&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">TTree</span><span class="w"> </span><span class="o">*</span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TTree</span><span class="p">(</span><span class="s">&quot;tree_vals&quot;</span><span class="p">,</span><span class="s">&quot;tree_vals&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="kt">float</span><span class="w"> </span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">fb</span><span class="p">;</span>

<span class="w">   </span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">Branch</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fb</span><span class="p">,</span><span class="s">&quot;f/F&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">Branch</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">xb</span><span class="p">,</span><span class="s">&quot;x/F&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">Branch</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">yb</span><span class="p">,</span><span class="s">&quot;y/F&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">TRandom3</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TRandom3</span><span class="p">();</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">nentries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="c1">// just use a regular grid of 20x20=400 points</span>

<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.2</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.2</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.2</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.2</span><span class="p">;</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;</span><span class="n">nentries</span><span class="p">;</span><span class="n">n</span><span class="o">++</span><span class="p">){</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">nentries</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">){</span>

<span class="w">      </span><span class="n">xb</span><span class="o">=</span><span class="n">xmin</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">nentries</span><span class="p">);</span>
<span class="w">      </span><span class="n">yb</span><span class="o">=</span><span class="n">ymin</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">((</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">nentries</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Gaussian * cosine function radial in &quot;F(x^2+y^2)&quot;</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xb</span><span class="o">*</span><span class="n">xb</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">yb</span><span class="o">*</span><span class="n">yb</span><span class="p">);</span>
<span class="w">      </span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">TMath</span><span class="o">::</span><span class="n">Exp</span><span class="p">(</span><span class="mi">-1</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span><span class="o">*</span><span class="n">TMath</span><span class="o">::</span><span class="n">Cos</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">TMath</span><span class="o">::</span><span class="n">Sqrt</span><span class="p">(</span><span class="n">R</span><span class="p">));</span>
<span class="w">      </span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">Fill</span><span class="p">();</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// 2D graph of points in tree</span>
<span class="w">   </span><span class="n">TGraph2D</span><span class="w"> </span><span class="o">*</span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TGraph2D</span><span class="p">();</span>
<span class="w">   </span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">SetMarkerSize</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span>
<span class="w">   </span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">SetMarkerStyle</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">c0</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">p</span><span class="o">&lt;</span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">GetEntries</span><span class="p">();</span><span class="n">p</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="n">tree</span><span class="o">-&gt;</span><span class="n">GetEntry</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">fb</span><span class="p">);</span>
<span class="w">        </span><span class="n">c0</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>


<span class="w">   </span><span class="c1">// ------------------------------ THIS IS WHERE WE BUILD THE SPLINE ------------------------ //</span>
<span class="w">   </span><span class="c1">// Create 2 Real-vars, one for each of the parameters of the spline</span>
<span class="w">   </span><span class="c1">// The variables MUST be named the same as the corresponding branches in the tree</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">);</span>


<span class="w">   </span><span class="c1">// And the spline - arguments are</span>
<span class="w">   </span><span class="c1">// Required -&gt;   name, title, arglist of dependants, input tree,</span>
<span class="w">   </span><span class="c1">// Optional -&gt;  function branch name, interpolation width (tunable parameter), rescale Axis bool, cutstring</span>
<span class="w">   </span><span class="c1">// The tunable parameter gives the radial basis a &quot;width&quot;, over which the interpolation will be effectively taken</span>

<span class="w">   </span><span class="c1">// the reascale Axis bool (if true) will first try to rescale the points so that they are of order 1 in range</span>
<span class="w">   </span><span class="c1">// This can be helpful if for example one dimension is in much larger units than another.</span>

<span class="w">   </span><span class="c1">// The cutstring is just a ROOT string which can be used to apply cuts to the tree in case only a sub-set of the points should be used</span>

<span class="w">   </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">args</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooSplineND</span><span class="w"> </span><span class="o">*</span><span class="n">spline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RooSplineND</span><span class="p">(</span><span class="s">&quot;spline&quot;</span><span class="p">,</span><span class="s">&quot;spline&quot;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">tree</span><span class="p">,</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// ----------------------------------------------------------------------------------------- //</span>


<span class="w">   </span><span class="c1">//TGraph *gr = spline-&gt;getGraph(&quot;x&quot;,0.1); // Return 1D graph. Will be a slice of the spline for fixed y generated at steps of 0.1</span>

<span class="w">   </span><span class="c1">// Plot the 2D spline</span>
<span class="w">   </span><span class="n">TGraph2D</span><span class="w"> </span><span class="o">*</span><span class="n">gr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TGraph2D</span><span class="p">();</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">xx</span><span class="o">=</span><span class="n">xmin</span><span class="p">;</span><span class="n">xx</span><span class="o">&lt;</span><span class="n">xmax</span><span class="p">;</span><span class="n">xx</span><span class="o">+=</span><span class="mf">0.1</span><span class="p">){</span>
<span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">yy</span><span class="o">=</span><span class="n">xmin</span><span class="p">;</span><span class="n">yy</span><span class="o">&lt;</span><span class="n">ymax</span><span class="p">;</span><span class="n">yy</span><span class="o">+=</span><span class="mf">0.1</span><span class="p">){</span>
<span class="w">        </span><span class="n">x</span><span class="p">.</span><span class="n">setVal</span><span class="p">(</span><span class="n">xx</span><span class="p">);</span>
<span class="w">        </span><span class="n">y</span><span class="p">.</span><span class="n">setVal</span><span class="p">(</span><span class="n">yy</span><span class="p">);</span>
<span class="w">        </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">spline</span><span class="o">-&gt;</span><span class="n">getVal</span><span class="p">());</span>
<span class="w">        </span><span class="n">pt</span><span class="o">++</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">SetLineColor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="c1">//p0-&gt;SetTitle(&quot;0.1 exp(-(x{^2}+y{^2})/9) #times Cos(2.5#sqrt{x^{2}+y^{2}})&quot;);</span>
<span class="w">   </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">(</span><span class="s">&quot;surf&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">p0</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">(</span><span class="s">&quot;Pcolsame&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="c1">//p0-&gt;Draw(&quot;surfsame&quot;);</span>
<span class="w">   </span><span class="n">TLegend</span><span class="w"> </span><span class="o">*</span><span class="n">leg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TLegend</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.82</span><span class="p">,</span><span class="mf">0.82</span><span class="p">,</span><span class="mf">0.98</span><span class="p">);</span>
<span class="w">   </span><span class="n">leg</span><span class="o">-&gt;</span><span class="n">SetFillColor</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">leg</span><span class="o">-&gt;</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="s">&quot;0.1 exp(-(x{^2}+y{^2})/9) #times Cos(2.5#sqrt{x^{2}+y^{2}})&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">leg</span><span class="o">-&gt;</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">gr</span><span class="p">,</span><span class="s">&quot;RooSplineND (N=2) interpolation&quot;</span><span class="p">,</span><span class="s">&quot;L&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">leg</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</details>

<p>Running the script will produce the following plot. The plot shows the sampled points and the spline produced from them.</p>
<p><img alt="" src="../images/colspline.png" /></p>
<h2 id="rooparametrichist-gamman-for-shapes">RooParametricHist gammaN for shapes</h2>
<p>Currently, there is no straightforward implementation of using per-bin <strong>gmN</strong>-like uncertainties with shape (histogram) analyses. Instead, it is possible to tie control regions (written as datacards) with the signal region using three methods.</p>
<p>For analyses that take the normalization of some process from a control region, it is possible to use either <strong>lnU</strong> or <strong>rateParam</strong> directives to float the normalization in a correlated way of some process between two regions. Instead if each bin is intended to be determined via a control region, one can use a number of <code>RooFit</code> histogram PDFs/functions to accomplish this. The example below shows a simple implementation of a <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit/blob/main/interface/RooParametricHist.h">RooParametricHist</a> to achieve this.</p>
<p>Copy the script below into a file called <code>examplews.C</code> and create the input workspace using <code>root -l examplews.C</code>...</p>
<details>
<summary><b>Show script</b></summary>

<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">examplews</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// As usual, load the combine library to get access to the RooParametricHist</span>
<span class="w">    </span><span class="n">gSystem</span><span class="o">-&gt;</span><span class="n">Load</span><span class="p">(</span><span class="s">&quot;libHiggsAnalysisCombinedLimit.so&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Output file and workspace</span>
<span class="w">    </span><span class="n">TFile</span><span class="w"> </span><span class="o">*</span><span class="n">fOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TFile</span><span class="p">(</span><span class="s">&quot;param_ws.root&quot;</span><span class="p">,</span><span class="s">&quot;RECREATE&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooWorkspace</span><span class="w"> </span><span class="n">wspace</span><span class="p">(</span><span class="s">&quot;wspace&quot;</span><span class="p">,</span><span class="s">&quot;wspace&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// better to create the bins rather than use the &quot;nbins,min,max&quot; to avoid spurious warning about adding bins with different</span>
<span class="w">    </span><span class="c1">// ranges in combine - see https://root-forum.cern.ch/t/attempt-to-divide-histograms-with-different-bin-limits/17624/3 for why!</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nbins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">xmin</span><span class="o">=</span><span class="mf">200.</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">xmax</span><span class="o">=</span><span class="mf">1000.</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">xbins</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">200.</span><span class="p">,</span><span class="mf">400.</span><span class="p">,</span><span class="mf">600.</span><span class="p">,</span><span class="mf">800.</span><span class="p">,</span><span class="mf">1000.</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// A search in a MET tail, define MET as our variable</span>

<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">met</span><span class="p">(</span><span class="s">&quot;met&quot;</span><span class="p">,</span><span class="s">&quot;E_{T}^{miss}&quot;</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">vars</span><span class="p">(</span><span class="n">met</span><span class="p">);</span>


<span class="w">    </span><span class="c1">// ---------------------------- SIGNAL REGION -------------------------------------------------------------------//</span>
<span class="w">    </span><span class="c1">// Make a dataset, this will be just four bins in MET.</span>
<span class="w">    </span><span class="c1">// its easiest to make this from a histogram. Set the contents to &quot;somehting&quot;</span>
<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">data_th1</span><span class="p">(</span><span class="s">&quot;data_obs_SR&quot;</span><span class="p">,</span><span class="s">&quot;Data observed in signal region&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>

<span class="w">    </span><span class="n">data_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">25</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">data_hist</span><span class="p">(</span><span class="s">&quot;data_obs_SR&quot;</span><span class="p">,</span><span class="s">&quot;Data observed&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">data_th1</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">data_hist</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// In the signal region, our background process will be freely floating,</span>
<span class="w">    </span><span class="c1">// Create one parameter per bin representing the yield. (note of course we can have multiple processes like this)</span>
<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin1</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin1&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 1&quot;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin2</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin2&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 2&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin3</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin3&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 3&quot;</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin4</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin4&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 4&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">bkg_SR_bins</span><span class="p">;</span>
<span class="w">    </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin1</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin2</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin3</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin4</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create a RooParametericHist which contains those yields, last argument is just for the binning,</span>
<span class="w">    </span><span class="c1">// can use the data TH1 for that</span>
<span class="w">    </span><span class="n">RooParametricHist</span><span class="w"> </span><span class="n">p_bkg</span><span class="p">(</span><span class="s">&quot;bkg_SR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background PDF in signal region&quot;</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bkg_SR_bins</span><span class="p">,</span><span class="n">data_th1</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Always include a _norm term which should be the sum of the yields (thats how combine likes to play with pdfs)</span>
<span class="w">    </span><span class="n">RooAddition</span><span class="w"> </span><span class="n">p_bkg_norm</span><span class="p">(</span><span class="s">&quot;bkg_SR_norm&quot;</span><span class="p">,</span><span class="s">&quot;Total Number of events from background in signal region&quot;</span><span class="p">,</span><span class="n">bkg_SR_bins</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Every signal region needs a signal</span>
<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">signal_th1</span><span class="p">(</span><span class="s">&quot;signal_SR&quot;</span><span class="p">,</span><span class="s">&quot;Signal expected in signal region&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>

<span class="w">    </span><span class="n">signal_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">signal_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">signal_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">signal_th1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">signal_hist</span><span class="p">(</span><span class="s">&quot;signal&quot;</span><span class="p">,</span><span class="s">&quot;Data observed&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">signal_th1</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">signal_hist</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// -------------------------------------------------------------------------------------------------------------//</span>
<span class="w">    </span><span class="c1">// ---------------------------- CONTROL REGION -----------------------------------------------------------------//</span>
<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">data_CRth1</span><span class="p">(</span><span class="s">&quot;data_obs_CR&quot;</span><span class="p">,</span><span class="s">&quot;Data observed in control region&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>

<span class="w">    </span><span class="n">data_CRth1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">200</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_CRth1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_CRth1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<span class="w">    </span><span class="n">data_CRth1</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>

<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">data_CRhist</span><span class="p">(</span><span class="s">&quot;data_obs_CR&quot;</span><span class="p">,</span><span class="s">&quot;Data observed&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">data_CRth1</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">data_CRhist</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// This time, the background process will be dependent on the yields of the background in the signal region.</span>
<span class="w">    </span><span class="c1">// The transfer factor TF must account for acceptance/efficiency etc differences in the signal to control</span>
<span class="w">    </span><span class="c1">// In this example lets assume the control region is populated by the same process decaying to clean daughters with 2xBR</span>
<span class="w">    </span><span class="c1">// compared to the signal region</span>

<span class="w">    </span><span class="c1">// NB You could have a different transfer factor for each bin represented by a completely different RooRealVar</span>

<span class="w">    </span><span class="c1">// We can imagine that the transfer factor could be associated with some uncertainty - lets say a 1% uncertainty due to efficiency and 2% due to acceptance.</span>
<span class="w">    </span><span class="c1">// We need to make these nuisance parameters ourselves and give them a nominal value of 0</span>


<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">efficiency</span><span class="p">(</span><span class="s">&quot;efficiency&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;efficiency nuisance parameter&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">acceptance</span><span class="p">(</span><span class="s">&quot;acceptance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;acceptance nuisance parameter&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// We would need to make the transfer factor a function of those too. Here we&#39;ve assumed Log-normal effects (i.e the same as putting lnN in the CR datacard)</span>
<span class="w">    </span><span class="c1">// but note that we could use any function which could be used to parameterise the effect - eg if the systematic is due to some alternate template, we could</span>
<span class="w">    </span><span class="c1">// use polynomials for example.</span>


<span class="w">    </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">TF</span><span class="p">(</span><span class="s">&quot;TF&quot;</span><span class="p">,</span><span class="s">&quot;Trasnfer factor&quot;</span><span class="p">,</span><span class="s">&quot;2*TMath::Power(1.01,@0)*TMath::Power(1.02,@1)&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">efficiency</span><span class="p">,</span><span class="n">acceptance</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Finally, we need to make each bin of the background in the control region a function of the background in the signal and the transfer factor</span>
<span class="w">    </span><span class="c1">// N_CR = N_SR x TF</span>

<span class="w">    </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin1</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin1&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 1&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin1</span><span class="p">));</span>
<span class="w">    </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin2</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin2&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 2&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin2</span><span class="p">));</span>
<span class="w">    </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin3</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin3&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 3&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin3</span><span class="p">));</span>
<span class="w">    </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin4</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin4&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 4&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin4</span><span class="p">));</span>

<span class="w">    </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">bkg_CR_bins</span><span class="p">;</span>
<span class="w">    </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin1</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin2</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin3</span><span class="p">);</span>
<span class="w">    </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin4</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooParametricHist</span><span class="w"> </span><span class="n">p_CRbkg</span><span class="p">(</span><span class="s">&quot;bkg_CR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background PDF in control region&quot;</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bkg_CR_bins</span><span class="p">,</span><span class="n">data_th1</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooAddition</span><span class="w"> </span><span class="n">p_CRbkg_norm</span><span class="p">(</span><span class="s">&quot;bkg_CR_norm&quot;</span><span class="p">,</span><span class="s">&quot;Total Number of events from background in control region&quot;</span><span class="p">,</span><span class="n">bkg_CR_bins</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// -------------------------------------------------------------------------------------------------------------//</span>


<span class="w">    </span><span class="c1">// we can also use the standard interpolation from combine by providing alternative shapes (as RooDataHists)</span>
<span class="w">    </span><span class="c1">// here we&#39;re adding two of them (JES and ISR)</span>
<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_up</span><span class="p">(</span><span class="s">&quot;tbkg_CR_JESUp&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.01</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.02</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.03</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.04</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sysUp</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESUp&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys up&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_up</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sysUp</span><span class="p">);</span>

<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_down</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESDown&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.90</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.98</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.97</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.96</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sysDown</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESDown&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys down&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_down</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sysDown</span><span class="p">);</span>

<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_2up</span><span class="p">(</span><span class="s">&quot;tbkg_CR_ISRUp&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.85</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.9</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.99</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sys2Up</span><span class="p">(</span><span class="s">&quot;bkg_CR_ISRUp&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys 2up&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_2up</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sys2Up</span><span class="p">);</span>

<span class="w">    </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_2down</span><span class="p">(</span><span class="s">&quot;bkg_CR_ISRDown&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.15</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.05</span><span class="p">);</span>
<span class="w">    </span><span class="n">background_2down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.01</span><span class="p">);</span>
<span class="w">    </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sys2Down</span><span class="p">(</span><span class="s">&quot;bkg_CR_ISRDown&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys 2down&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_2down</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sys2Down</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// import the pdfs</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">p_bkg</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">p_bkg_norm</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">RecycleConflictNodes</span><span class="p">());</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">p_CRbkg</span><span class="p">);</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">p_CRbkg_norm</span><span class="p">,</span><span class="n">RooFit</span><span class="o">::</span><span class="n">RecycleConflictNodes</span><span class="p">());</span>
<span class="w">    </span><span class="n">fOut</span><span class="o">-&gt;</span><span class="n">cd</span><span class="p">();</span>
<span class="w">    </span><span class="n">wspace</span><span class="p">.</span><span class="n">Write</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Clean up</span>
<span class="w">    </span><span class="n">fOut</span><span class="o">-&gt;</span><span class="n">Close</span><span class="p">();</span>
<span class="w">    </span><span class="n">fOut</span><span class="o">-&gt;</span><span class="n">Delete</span><span class="p">();</span>


<span class="p">}</span>
</code></pre></div>

</details>

<p>We will now discuss what the script is doing. First, the observable for the search is the missing energy, so we create a parameter to represent this observable.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">met</span><span class="p">(</span><span class="s">&quot;met&quot;</span><span class="p">,</span><span class="s">&quot;E_{T}^{miss}&quot;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">);</span>
</code></pre></div>
<p>The following lines create a freely floating parameter for each of our bins (in this example, there are only 4 bins, defined for our observable <code>met</code>).</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin1</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin1&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 1&quot;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin2</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin2&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 2&quot;</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin3</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin3&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 3&quot;</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">bin4</span><span class="p">(</span><span class="s">&quot;bkg_SR_bin4&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in signal region, bin 4&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">);</span>

<span class="w">   </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">bkg_SR_bins</span><span class="p">;</span>
<span class="w">   </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin1</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin2</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin3</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_SR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">bin4</span><span class="p">);</span>
</code></pre></div>
<p>They are put into a list so that we can create a <code>RooParametricHist</code> and its normalisation from that list</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">RooParametricHist</span><span class="w"> </span><span class="n">p_bkg</span><span class="p">(</span><span class="s">&quot;bkg_SR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background PDF in signal region&quot;</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bkg_SR_bins</span><span class="p">,</span><span class="n">data_th1</span><span class="p">);</span>

<span class="w">  </span><span class="n">RooAddition</span><span class="w"> </span><span class="n">p_bkg_norm</span><span class="p">(</span><span class="s">&quot;bkg_SR_norm&quot;</span><span class="p">,</span><span class="s">&quot;Total Number of events from background in signal region&quot;</span><span class="p">,</span><span class="n">bkg_SR_bins</span><span class="p">);</span>
</code></pre></div>
<p>For the control region, the background process will be dependent on the yields of the background in the signal region using a <em>transfer factor</em>. The transfer factor <code>TF</code> must account for acceptance/efficiency/etc differences between the signal region and the control regions.</p>
<p>In this example we will assume the control region is populated by the same process decaying to a different final state with twice as large branching fraction as the one in the signal region.</p>
<p>We could imagine that the transfer factor could be associated with some uncertainty - for example a 1% uncertainty due to efficiency and a 2% uncertainty due to acceptance differences. We need to make nuisance parameters ourselves to model this, and give them a nominal value of 0.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">efficiency</span><span class="p">(</span><span class="s">&quot;efficiency&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;efficiency nuisance parameter&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooRealVar</span><span class="w"> </span><span class="n">acceptance</span><span class="p">(</span><span class="s">&quot;acceptance&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;acceptance nuisance parameter&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>
<p>We need to make the transfer factor a function of these parameters, since variations in these uncertainties will lead to variations of the transfer factor. Here we have assumed Log-normal effects (i.e the same as putting lnN in the CR datacard), but we could use <em>any function</em> which could be used to parameterize the effect - for example if the systematic uncertainty is due to some alternate template, we could use polynomials.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">TF</span><span class="p">(</span><span class="s">&quot;TF&quot;</span><span class="p">,</span><span class="s">&quot;Trasnfer factor&quot;</span><span class="p">,</span><span class="s">&quot;2*TMath::Power(1.01,@0)*TMath::Power(1.02,@1)&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">efficiency</span><span class="p">,</span><span class="n">acceptance</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>Then, we need to make each bin of the background in the control region a function of the background in the signal region and the transfer factor - i.e $N<em>{CR} = N</em>{SR} \times TF $.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin1</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin1&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 1&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin1</span><span class="p">));</span>
<span class="w">   </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin2</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin2&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 2&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin2</span><span class="p">));</span>
<span class="w">   </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin3</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin3&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 3&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin3</span><span class="p">));</span>
<span class="w">   </span><span class="n">RooFormulaVar</span><span class="w"> </span><span class="n">CRbin4</span><span class="p">(</span><span class="s">&quot;bkg_CR_bin4&quot;</span><span class="p">,</span><span class="s">&quot;Background yield in control region, bin 4&quot;</span><span class="p">,</span><span class="s">&quot;@0*@1&quot;</span><span class="p">,</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">TF</span><span class="p">,</span><span class="n">bin4</span><span class="p">));</span>
</code></pre></div>
<p>As before, we also need to create the <code>RooParametricHist</code> for this process in the control region but this time the bin yields will be the <code>RooFormulaVars</code> we just created instead of freely floating parameters.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">RooArgList</span><span class="w"> </span><span class="n">bkg_CR_bins</span><span class="p">;</span>
<span class="w">   </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin1</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin2</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin3</span><span class="p">);</span>
<span class="w">   </span><span class="n">bkg_CR_bins</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">CRbin4</span><span class="p">);</span>

<span class="w">   </span><span class="n">RooParametricHist</span><span class="w"> </span><span class="n">p_CRbkg</span><span class="p">(</span><span class="s">&quot;bkg_CR&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Background PDF in control region&quot;</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bkg_CR_bins</span><span class="p">,</span><span class="n">data_th1</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooAddition</span><span class="w"> </span><span class="n">p_CRbkg_norm</span><span class="p">(</span><span class="s">&quot;bkg_CR_norm&quot;</span><span class="p">,</span><span class="s">&quot;Total Number of events from background in control region&quot;</span><span class="p">,</span><span class="n">bkg_CR_bins</span><span class="p">);</span>
</code></pre></div>
<p>Finally, we can also create alternative shape variations (Up/Down) that can be fed to <span style="font-variant:small-caps;">Combine</span> as we do with <code>TH1</code> or <code>RooDataHist</code> type workspaces. These need
to be of type <code>RooDataHist</code>. The example below is for a Jet Energy Scale type shape uncertainty.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_up</span><span class="p">(</span><span class="s">&quot;tbkg_CR_JESUp&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.01</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.02</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.03</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_up</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">1.04</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sysUp</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESUp&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys up&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_up</span><span class="p">);</span>
<span class="w">   </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sysUp</span><span class="p">);</span>

<span class="w">   </span><span class="n">TH1F</span><span class="w"> </span><span class="n">background_down</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESDown&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">nbins</span><span class="p">,</span><span class="n">xbins</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">CRbin1</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.90</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">CRbin2</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.98</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">CRbin3</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.97</span><span class="p">);</span>
<span class="w">   </span><span class="n">background_down</span><span class="p">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">CRbin4</span><span class="p">.</span><span class="n">getVal</span><span class="p">()</span><span class="o">*</span><span class="mf">0.96</span><span class="p">);</span>
<span class="w">   </span><span class="n">RooDataHist</span><span class="w"> </span><span class="n">bkg_CRhist_sysDown</span><span class="p">(</span><span class="s">&quot;bkg_CR_JESDown&quot;</span><span class="p">,</span><span class="s">&quot;Bkg sys down&quot;</span><span class="p">,</span><span class="n">vars</span><span class="p">,</span><span class="o">&amp;</span><span class="n">background_down</span><span class="p">);</span>
<span class="w">   </span><span class="n">wspace</span><span class="p">.</span><span class="k">import</span><span class="p">(</span><span class="n">bkg_CRhist_sysDown</span><span class="p">);</span>
</code></pre></div>
<p>Below are datacards (for signal and control regions) which can be used in conjunction with the workspace built above. In order to "use" the control region, simply combine the two cards as usual using <code>combineCards.py</code>.</p>
<details>
<summary><b>Show Signal Region Datacard</b></summary>
<div class="highlight"><pre><span></span><code>Signal Region Datacard -- signal category

imax _ number of bins
jmax _ number of processes minus 1
kmax \* number of nuisance parameters

---

shapes data_obs signal param_ws.root wspace:data_obs_SR
shapes background signal param_ws.root wspace:bkg_SR # the background model pdf which is freely floating, note other backgrounds can be added as usual
shapes signal signal param_ws.root wspace:signal

---

bin signal
observation -1

---

# background rate must be taken from \_norm param x 1

bin signal signal
process background signal
process 1 0
rate 1 -1

---

# Normal uncertainties in the signal region

## lumi_8TeV lnN - 1.026

# free floating parameters, we do not need to declare them, but its a good idea to

bkg_SR_bin1 flatParam
bkg_SR_bin2 flatParam
bkg_SR_bin3 flatParam
bkg_SR_bin4 flatParam
</code></pre></div>
</details>
<details>
<summary><b>Show Control Region Datacard</b></summary>
<div class="highlight"><pre><span></span><code>Control Region Datacard -- control category

imax _ number of bins
jmax _ number of processes minus 1
kmax \* number of nuisance parameters

---

shapes data*obs control param_ws.root wspace:data_obs_CR
shapes background control param_ws.root wspace:bkg_CR wspace:bkg_CR*$SYSTEMATIC # the background model pdf which is dependant on that in the SR, note other backgrounds can be added as usual

---

bin control
observation -1

---

# background rate must be taken from \_norm param x 1

bin control
process background
process 1
rate 1

---

JES shape 1
ISR shape 1
efficiency param 0 1
acceptance param 0 1
</code></pre></div>
</details>

<p>Note that for the control region, our nuisance parameters appear as <code>param</code> types, so that <span style="font-variant:small-caps;">Combine</span> will correctly constrain them.</p>
<p>If we combine the two cards and fit the result with <code>-M MultiDimFit -v 3</code> we can see that the parameters that give the rate of background in each bin of the signal region, along with the nuisance parameters and signal strength, are determined by the fit - i.e we have properly included the constraint from the control region, just as with the 1-bin <code>gmN</code>.</p>
<div class="highlight"><pre><span></span><code>acceptance = 0.00374312 +/- 0.964632 (limited)
bkg_SR_bin1 = 99.9922 +/- 5.92062 (limited)
bkg_SR_bin2 = 49.9951 +/- 4.13535 (limited)
bkg_SR_bin3 = 24.9915 +/- 2.9267 (limited)
bkg_SR_bin4 = 9.96478 +/- 2.1348 (limited)
efficiency = 0.00109195 +/- 0.979334 (limited)
lumi_8TeV = -0.0025911 +/- 0.994458
r = 0.00716347 +/- 12.513 (limited)
</code></pre></div>
<p>The example given here is extremely basic and it should be noted that additional complexity in the transfer factors, as well as additional uncertainties/backgrounds etc in the cards are, as always, supported.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>If trying to implement parametric uncertainties in this setup (eg on transfer factors) that are correlated with other channels and implemented separately, you <strong><em>MUST</em></strong> normalize the uncertainty effect so that the datacard line can read <code>param name X 1</code>. That is, the uncertainty on this parameter must be 1. Without this, there will be inconsistency with other nuisances of the same name in other channels implemented as <strong>shape</strong> or <strong>lnN</strong>.</p>
</div>
<h2 id="look-elsewhere-effect-for-one-parameter">Look-elsewhere effect for one parameter</h2>
<p>In case you see an excess somewhere in your analysis, you can evaluate the look-elsewhere effect (LEE) of that excess. For an explanation of the LEE, take a look at the CMS Statistics Committee Twiki <a href="https://twiki.cern.ch/twiki/bin/viewauth/CMS/LookElsewhereEffect">here</a>.</p>
<p>To calculate the look-elsewhere effect for a single parameter (in this case the mass of the resonance), you can follow the instructions below. Note that these instructions assume you have a workspace that is parametric in your resonance mass <span class="arithmatex">\(m\)</span>, otherwise you need to fit each background toy with separate workspaces. We will assume the local significance for your excess is <span class="arithmatex">\(\sigma\)</span>.</p>
<ul>
<li>
<p>Generate background-only toys <code>combine ws.root -M GenerateOnly --toysFrequentist -m 16.5 -t 100 --saveToys --expectSignal=0</code>. The output will be something like <code>higgsCombineTest.GenerateOnly.mH16.5.123456.root</code>.</p>
</li>
<li>
<p>For each toy, calculate the significance for a predefined range (e.g <span class="arithmatex">\(m\in [10,35]\)</span> GeV) in steps suitable to the resolution (e.g. 1 GeV). For <code>toy_1</code> the procedure would be: <code>for i in $(seq 10 35); do combine ws.root -M Significance --redefineSignalPOI r --freezeParameters MH --setParameter MH=$i -n $i -D higgsCombineTest.GenerateOnly.mH16.5.123456.root:toys/toy_1</code>. Calculate the maximum significance over all of these mass points - call this <span class="arithmatex">\(\sigma_{max}\)</span>.</p>
</li>
<li>
<p>Count how many toys have a maximum significance larger than the local one for your observed excess. This fraction of toys with <span class="arithmatex">\(\sigma_{max}&gt;\sigma\)</span> is the global p-value.</p>
</li>
</ul>
<p>You can find more tutorials on the LEE <a href="https://indico.cern.ch/event/456547/contributions/1126036/attachments/1188691/1724680/20151117_comb_tutorial_Lee.pdf">here</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../commonstatsmethods/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Common statistical methods">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Common statistical methods
              </div>
            </div>
          </a>
        
        
          
          <a href="../simplifiedlikelihood/" class="md-footer__link md-footer__link--next" aria-label="Next: Simplified Likelihoods">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Simplified Likelihoods
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.footer", "navigation.indexes", "navigation.expand", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>