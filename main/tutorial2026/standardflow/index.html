
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../part5/longexerciseanswers/">
      
      
        <link rel="next" href="../../tutorial2023/parametric_exercise/">
      
      
        
      
      
      <link rel="icon" href="../../logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Analysis flow - Combine</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../mystyle.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#main-features-of-combine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../.."> 


    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Combine" class="md-header__button md-logo" aria-label="Combine" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Combine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analysis flow
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../what_combine_does/introduction/" class="md-tabs__link">
          
  
  
    
  
  What Combine Does

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part2/settinguptheanalysis/" class="md-tabs__link">
          
  
  
    
  
  Setting Up the Analysis

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part3/runningthetool/" class="md-tabs__link">
          
  
  
    
  
  Running Combine

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../part5/roofit/" class="md-tabs__link">
          
  
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part6/in_browser_tools/" class="md-tabs__link">
          
  
  
    
  
  In-Browser Tools

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../part4/usefullinks/" class="md-tabs__link">
        
  
  
    
  
  Links & FAQ

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Combine" class="md-nav__button md-logo" aria-label="Combine" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    Combine
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cms-analysis/HiggsAnalysis-CombinedLimit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    What Combine Does
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    What Combine Does
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/model_and_likelihood/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model and Likelihood
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/fitting_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fitting Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../what_combine_does/statistical_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistical Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Setting Up the Analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Setting Up the Analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/settinguptheanalysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preparing the Datacard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Physics Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Physics Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/physicsmodels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/higgscouplings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SM Higgs Coupling Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/bsm-higgs-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BSM Higgs Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/bin-wise-stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automatic MC Statistical Uncertainties
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Running Combine
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Running Combine
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/runningthetool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running the Tool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/commonstatsmethods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common Statistical Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/nonstandard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Use Cases
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/simplifiedlikelihood/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simplified Likelihoods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/regularisation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unfolding & Regularization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validating Datacards
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging Fit Failures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/roofit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RooFit Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Main Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Main Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/longexercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exercises
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/longexerciseanswers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Solutions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Analysis flow
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Analysis flow
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      
        Background
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting started
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-1-setting-up-the-datacard-and-the-workspace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 1: Setting up the datacard and the workspace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 1: Setting up the datacard and the workspace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-setting-up-the-datacard" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Setting up the datacard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-mc-statistical-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: MC Statistical uncertainties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-control-regions" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Control regions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2-setup-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 2: Setup Validation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 2: Setup Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-using-fitdiagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Using FitDiagnostics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-nuisance-parameter-impacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: Nuisance parameter impacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-post-fit-distributions" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Post-fit distributions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-3-running-the-fit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 3: Running the fit
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 3: Running the fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-calculating-the-significance" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Calculating the significance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-signal-strength-measurement-and-uncertainty-breakdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: Signal strength measurement and uncertainty breakdown
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-computing-limits-with-toys" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Computing limits with toys
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial2023/parametric_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parametric Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial2023_unfolding/unfolding_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Likelihood-Based Unfolding
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial_stat_routines/stat_routines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistical Tests Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_building_tutorial2024/model_building_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Building
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../abcd_rooparametrichist_tutorial/rooparametrichist_exercise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Per-Bin Transfer Factors with Parametric Histograms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    In-Browser Tools
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    In-Browser Tools
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/in_browser_tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    In-Browser Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://root.cern/js/latest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Open: jsROOT (external)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/view_datacard.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Open: Datacard Viewer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part6/view_cov_json.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Open: Covariance Viewer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/usefullinks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Links & FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      
        Background
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting started
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-1-setting-up-the-datacard-and-the-workspace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 1: Setting up the datacard and the workspace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 1: Setting up the datacard and the workspace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-setting-up-the-datacard" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Setting up the datacard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-mc-statistical-uncertainties" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: MC Statistical uncertainties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-control-regions" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Control regions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2-setup-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 2: Setup Validation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 2: Setup Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-using-fitdiagnostics" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Using FitDiagnostics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-nuisance-parameter-impacts" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: Nuisance parameter impacts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-post-fit-distributions" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Post-fit distributions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-3-running-the-fit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part 3: Running the fit
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 3: Running the fit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-calculating-the-significance" class="md-nav__link">
    <span class="md-ellipsis">
      
        A: Calculating the significance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-signal-strength-measurement-and-uncertainty-breakdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        B: Signal strength measurement and uncertainty breakdown
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-computing-limits-with-toys" class="md-nav__link">
    <span class="md-ellipsis">
      
        C: Computing limits with toys
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="main-features-of-combine">Main Features of Combine</h1>
<p>This exercise is designed to recreate the main workflow needed to perform a statistical analysis with Combine. It will start assuming you already prepared your inputs (<strong>shapes, yields, and systematic uncertainties</strong>) and will proceed step by step to perform validation test of your setup and produce some standard results. For more detailed procedure you can always find detailed informations in the  <span style="font-variant:small-caps;">Combine</span> <a href="https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/latest/">manual</a> and in the <a href="https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/latest/part5/longexercise/">Long exercise tutorial</a>. </p>
<p>As for the Long exercise, we will work with a simplified version of a real analysis, that nonetheless will have many features of the full analysis. The analysis is a search for an additional heavy neutral Higgs boson decaying to tau lepton pairs. Such a signature is predicted in many extensions of the standard model, in particular the minimal supersymmetric standard model (MSSM). You can read about the analysis in the paper <a href="https://arxiv.org/pdf/1803.06553.pdf">here</a>. The statistical inference makes use of a variable called the total transverse mass (<span class="arithmatex">\(M_{\mathrm{T}}^{\mathrm{tot}}\)</span>) that provides good discrimination between the resonant high-mass signal and the main backgrounds, which have a falling distribution in this high-mass region. The events selected in the analysis are split into several categories which target the main di-tau final states as well as the two main production modes: gluon-fusion (ggH) and b-jet associated production (bbH). One example is given below for the fully-hadronic final state in the b-tag category which targets the bbH signal:</p>
<p><img alt="" src="../../part5/images/CMS-DAS.003.jpeg" /></p>
<h2 id="background">Background</h2>
<p>You can find a presentation with some more background on likelihoods and extracting confidence intervals <a href="https://indico.cern.ch/event/976099/contributions/4138517/">here</a>. A presentation that discusses limit setting in more detail can be found <a href="https://indico.cern.ch/event/976099/contributions/4138520/">here</a>.
If you are not yet familiar with these concepts, or would like to refresh your memory, we recommend that you have a look at these presentations before you start with the exercise.</p>
<h2 id="getting-started">Getting started</h2>
<p>To get started, you should have a working setup of <code>Combine</code>, please follow the instructions from the <a href="https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/latest/#within-cmssw-recommended-for-cms-users">home page</a>. Make sure to use the latest recommended release.</p>
<p>Now we will move to the working directory for this tutorial, which contains all the inputs needed to run the exercises below:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="nv">$CMSSW_BASE</span>/src/HiggsAnalysis/CombinedLimit/docs/tutorial2026/
</code></pre></div></p>
<h2 id="part-1-setting-up-the-datacard-and-the-workspace">Part 1: Setting up the datacard and the workspace</h2>
<p>Topics covered in this section:</p>
<ul>
<li>A: Setting up the datacard and the workspace</li>
<li>B: MC statistical uncertainties</li>
<li>C: Introducing control regions</li>
</ul>
<blockquote>
<p>[!TIP] 
To prepare the datacards you will need to collect all your inputs. This means having already selected, categorised, and analysed your data and MC, and having a settled strategy for at least the main background sources, so you are already well advanced in your analysis. Nevertheless, since without datacards you don't know yet how your results behave, we recommend to have this section ready during the WG review. The L3 and L2 will in any case need to see at least some first results before letting you progress further</p>
</blockquote>
<h3 id="a-setting-up-the-datacard">A: Setting up the datacard</h3>
<p>In a typical analysis we will produce some distribution of our observables, so that we can separate signal and background processes and compare them with data. Combine can receive as input TH1, RooHists, and RooPDFs of any dimensions. In this example we will use TH1 histograms: one for the data and one for each signal and background processes. An example datacard should look like:</p>
<details>
<summary><b>Show datacard</b></summary>
<div class="highlight"><pre><span></span><code>imax<span class="w"> </span><span class="m">1</span>
jmax<span class="w"> </span><span class="m">1</span>
kmax<span class="w"> </span>*
---------------
shapes<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>simple-shapes-TH1_input.root<span class="w"> </span><span class="nv">$PROCESS</span><span class="w"> </span><span class="nv">$PROCESS_$SYSTEMATIC</span>
shapes<span class="w"> </span>signal<span class="w"> </span>*<span class="w"> </span>simple-shapes-TH1_input.root<span class="w"> </span><span class="nv">$PROCESS$MASS</span><span class="w"> </span><span class="nv">$PROCESS$MASS_$SYSTEMATIC</span>
---------------
bin<span class="w"> </span>bin1
observation<span class="w"> </span><span class="m">85</span>
------------------------------
bin<span class="w">             </span>bin1<span class="w">       </span>bin1
process<span class="w">         </span>signal<span class="w">     </span>background
process<span class="w">         </span><span class="m">0</span><span class="w">          </span><span class="m">1</span>
rate<span class="w">            </span><span class="m">10</span><span class="w">         </span><span class="m">100</span>
--------------------------------
lumi<span class="w">     </span>lnN<span class="w">    </span><span class="m">1</span>.10<span class="w">       </span><span class="m">1</span>.0
bgnorm<span class="w">   </span>lnN<span class="w">    </span><span class="m">1</span>.00<span class="w">       </span><span class="m">1</span>.3
alpha<span class="w">  </span>shape<span class="w">    </span>-<span class="w">          </span><span class="m">1</span>
</code></pre></div>
</details>

<p>The first block tells  <span style="font-variant:small-caps;">Combine</span> (and readers) the number of bins/observables (imax), the number of background processes (jmax) and the number of nuisance parameters (kmax).
The second block tells  <span style="font-variant:small-caps;">Combine</span> where it can find the input shapes, according to the pattern <code>shapes [process] [channel] [file] [histogram] [histogram_with_systematics]</code>. It is possible to use the <code>*</code> wildcard to map multiple processes and/or channels with one line. The histogram entries can contain the <code>$PROCESS</code>, <code>$CHANNEL</code> and <code>$MASS</code> place-holders which will be substituted when searching for a given (process, channel) combination. The value of <code>$MASS</code> is specified by the <code>-m</code> argument when running combine. The final argument of the "shapes" line above should contain the <code>$SYSTEMATIC</code> place-holder which will be substituted by the systematic name given in the datacard. By default the observed data process name will be <code>data_obs</code>.
The third block lists for each bin the processes contributing to it and their rates (yields).
Finally, the last block lists the nuisance parameters. a lnN uncertainty means that the nuisance only affects the overall normalization, while a <code>shape</code> uncertainty affects the distributions of the events.</p>
<p>Note that the total nominal rate of a given process, specified in the <code>rate</code> line of the datacard, must agree with the value returned by <code>TH1::Integral</code>. However, we can also put a value of <code>-1</code> and the Integral value will be substituted automatically. While it makes easier to write down the cards, this features makes debugging and reading the card harder, use it at your own risk!</p>
<p>Shape uncertainties can be added by supplying two additional histograms for a process, corresponding to the distribution obtained by shifting that parameter up and down by one standard deviation. These shapes will be interpolated (see the <a href="../../part2/settinguptheanalysis/#template-shape-uncertainties">template shape uncertainties</a> section for details) for shifts within <span class="arithmatex">\(\pm1\sigma\)</span> and linearly extrapolated beyond. The normalizations are interpolated linearly in log scale just like we do for log-normal uncertainties.</p>
<p><img alt="" src="../../part5/images/shape_morphing.jpg" /></p>
<p>In the list of uncertainties the interpretation of the values for <code>shape</code> lines is a bit different from <code>lnN</code>. The effect can be "-" or 0 for no effect, 1 for normal effect, and possibly something different from 1 to test larger or smaller effects (in that case, the unit Gaussian is scaled by that factor before using it as parameter for the interpolation).</p>
<p><strong>Tasks and questions:</strong></p>
<p>Have a look at <code>datacard_part2.txt</code>: this is currently set up as a one-bin counting experiment, this means only yields are provided.</p>
<p>The <strong>first task</strong> is to convert this to a shape analysis: the file <code>datacard_part2.shapes.root</code> contains all the necessary histograms, including those for the relevant shape systematic uncertainties. Add the relevant <code>shapes</code> lines to the top of the datacard (after the <code>kmax</code> line) to map the processes to the correct TH1s in this file. Hint: you will need a different line for the signal process, since their naming patterns are different from the background ones.</p>
<p>Compared to the counting experiment we must also consider the effect of uncertainties that change the shape of the distribution. Some, like <code>CMS_eff_t_highpt</code>, are already present in the datacard, as it has both a shape and normalisation effect.</p>
<p>Add the following shape uncertainties: <code>top_pt_ttbar_shape</code> affecting <code>ttbar</code>,the tau energy scale uncertainties <code>CMS_scale_t_1prong0pi0_13TeV</code>, <code>CMS_scale_t_1prong1pi0_13TeV</code> and <code>CMS_scale_t_3prong0pi0_13TeV</code> affecting all processes except <code>jetFakes</code>, and <code>CMS_eff_t_highpt</code> also affecting the same processes.</p>
<p>Once this is done you can convert the text datacard into a RooFit workspace. If we feed the datacard directly into Combine, this step will be done internally every time we run. It is a good idea to do it explicitely especially for more complex analyses, since the conversion step can take a notable amount of time. For this we use the <code>text2workspace.py</code> command:</p>
<p><div class="highlight"><pre><span></span><code>text2workspace.py<span class="w"> </span>datacard_part2.txt<span class="w"> </span>-m<span class="w"> </span><span class="m">800</span><span class="w"> </span>-o<span class="w"> </span>workspace_part2.root
</code></pre></div>
And then we can verify that our setup works properly using this as input to combine. But before doing that there is one last item to discuss.
Most analyses are developed and optimised while we are "blind" to the region of data where we expect our signal to be. With the <code>AsymptoticLimits</code> method we can choose just to run the expected limit (<code>--run expected</code>), so as not to calculate the observed. However the data is still used, even for the expected, since in the frequentist approach a background-only fit to the data is performed to define the Asimov dataset used to calculate the expected limits. To skip this fit to data and use the pre-fit state of the model the option <code>--run blind</code> or <code>--noFitAsimov</code> can be used.</p>
<p>A more general way of blinding is to use combine's toy and Asimov dataset generating functionality (<code>--expectSignal [X] -t -1</code>). You can read more about this <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/runningthetool/#toy-data-generation">here</a>. These options can be used with any method in combine, not just <code>AsymptoticLimits</code>.</p>
<p>Now we can finally test our setup: 
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>AsymptoticLimits<span class="w"> </span>workspace_part2.root<span class="w"> </span>-m<span class="w"> </span><span class="m">800</span><span class="w"> </span>--run<span class="w"> </span>blind
</code></pre></div></p>
<p><strong>Tasks and questions:</strong>
  - Try to remove (comment out) the shape defining lines and systematics. This effectively transforms our shape analysis into a bin counting one. How much does the sensitivity of the shape analysis improved over the counting analysis?
  - Compare the expected limits calculated with <code>--run expected</code> and <code>--run blind</code>. Why are they different?
  - You can open the workspace ROOT file interactively and print the contents: <code>w-&gt;Print();</code>. Each process is represented by a PDF object that depends on the shape morphing nuisance parameters. From the workspace, choose a process and shape uncertainty, and make a plot overlaying the nominal shape with different values of the shape morphing nuisance parameter. You can change the value of a parameter with <code>w-&gt;var("X")-&gt;setVal(Y)</code>, and access a particular pdf with <code>w-&gt;pdf("Z")</code>. PDF objects in RooFit have a <a href="https://root.cern.ch/doc/master/classRooAbsReal.html#a552a08367c964e689515f2b5c92c8bbe">createHistogram</a> method that requires the name of the observable (the variable defining the x-axis) - this is called <code>CMS_th1x</code> in combine datacards. Feel free to ask for help with this!</p>
<h3 id="b-mc-statistical-uncertainties">B: MC Statistical uncertainties</h3>
<p>On top of yield and shape systematics, there is an important source of uncertainty we should introduce. Our estimates of the backgrounds come either from MC simulation or from sideband regions in data, and in both cases these estimates are subject to a statistical uncertainty on the number of simulated or data events.
In principle we should include an independent statistical uncertainty for every bin of every process in our model.
It's important to note that <span style="font-variant:small-caps;">Combine</span>/<code>RooFit</code> does not take this into account automatically - statistical fluctuations of the data are implicitly accounted for in the likelihood formalism, but statistical uncertainties in the model must be specified by us.</p>
<p>One way to implement these uncertainties is to create a <code>shape</code> uncertainty for each bin of each process, in which the up and down histograms have the contents of the bin
 shifted up and down by the <span class="arithmatex">\(1\sigma\)</span> uncertainty.
However this makes the likelihood evaluation computationally inefficient, and can lead to a large number of nuisance parameters
in more complex models. Instead we will use a feature in <span style="font-variant:small-caps;">Combine</span> called <code>autoMCStats</code> that creates these automatically from the datacard,
and uses a technique called "Barlow-Beeston-lite" to reduce the number of systematic uncertainties that are created.
This works on the assumption that for high MC event counts we can model the uncertainty with a Gaussian distribution. Given the uncertainties in different bins are independent, the total uncertainty of several processes in a particular bin is just the sum of <span class="arithmatex">\(N\)</span> individual Gaussians, which is itself a Gaussian distribution.
So instead of <span class="arithmatex">\(N\)</span> nuisance parameters we need only one. This breaks down when the number of events is small and we are not in the Gaussian regime.
The <code>autoMCStats</code> tool has a threshold setting on the number of events below which the the Barlow-Beeston-lite approach is not used, and instead a
Poisson PDF is used to model per-process uncertainties in that bin.</p>
<p>After reading the full documentation on <code>autoMCStats</code> <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part2/bin-wise-stats/">here</a>, add the corresponding line to your datacard.
Start by setting a threshold of 0, i.e. <code>[channel] autoMCStats 0</code>, to force the use of Barlow-Beeston-lite in all bins.</p>
<p>When running the <code>text2workspace</code> step on a datacard with autoMCStats enabled, you will get a report on how each bin has been treated by this algorithm.</p>
<p><strong>Tasks and questions:</strong>
  - Try to increase the Poisson threshold. How does the <code>text2workspace</code> report changes?</p>
<h3 id="c-control-regions">C: Control regions</h3>
<p>In a modern analysis it is typical for some or all of the backgrounds to be estimated using the data, instead of relying purely on MC simulation.
This can take many forms, but a common approach is to use "control regions" (CRs) that are pure and/or have higher statistics for a given process.
These are defined by event selections that are similar to, but non-overlapping with, the signal region. In our <span class="arithmatex">\(\phi\rightarrow\tau\tau\)</span> example the <span class="arithmatex">\(\text{Z}\rightarrow\tau\tau\)</span>
background normalisation can be calibrated using a <span class="arithmatex">\(\text{Z}\rightarrow\mu\mu\)</span> CR, and the <span class="arithmatex">\(\text{t}\bar{\text{t}}\)</span> background using an <span class="arithmatex">\(e+\mu\)</span> CR.
By comparing the number of data events in these CRs to our MC expectation we can obtain scale factors to apply to the corresponding backgrounds in the signal region (SR).
The idea is that the data will gives us a more accurate prediction of the background with less systematic uncertainties.
For example, we can remove the cross section and acceptance uncertainties in the SR, since we are no longer using the MC prediction (with a caveat discussed below).
While we could simply derive these correction factors and apply them to our signal region datacard a better way is to include these regions in our fit model and
tie the normalisations of the backgrounds in the CR and SR together. This has a number of advantages:</p>
<ul>
<li>Automatically handles the statistical uncertainty due to the number of data events in the CR</li>
<li>Allows for the presence of some signal contamination in the CR to be handled correctly</li>
<li>The CRs are typically not 100% pure in the background they're meant to control - other backgrounds may be present, with their own systematic uncertainties, some of which may be correlated with the SR or other CRs. Propagating these effects through to the SR "by hand" can become very challenging.</li>
</ul>
<p>In this section we will continue to use the same SR as in the previous one, however we will switch to a lower signal mass hypothesis, <span class="arithmatex">\(m_{\phi}=200\)</span>GeV, as its sensitivity depends more strongly on the background prediction than the high mass signal, so is better for illustrating the use of CRs. Here the nominal signal (<code>r=1</code>) has been normalised to a cross section of 1 pb.</p>
<p>The SR datacard for the 200 GeV signal is <code>datacard_part3.txt</code>. Two further datacards are provided: <code>datacard_part3_ttbar_cr.txt</code> and <code>datacard_part3_DY_cr.txt</code>
which represent the CRs for the Drell-Yan and <span class="arithmatex">\(\text{t}\bar{\text{t}}\)</span> processes as described above.
The cross section and acceptance uncertainties for these processes have pre-emptively been removed from the SR card.
However we cannot get away with neglecting acceptance effects altogether.
We are still implicitly using the MC simulation to predict to the ratio of events in the CR and SR, and this ratio will in general carry a theoretical acceptance uncertainty.
If the CRs are well chosen then this uncertainty should be smaller than the direct acceptance uncertainty in the SR however.
The uncertainties <code>acceptance_ttbar_cr</code> and <code>acceptance_DY_cr</code> have been added to these datacards cover this effect. <strong>Task:</strong> Calculate the ratio of CR to SR events for these two processes, as well as their CR purity to verify that these are useful CRs.</p>
<p>The next step is to combine these datacards into one, which is done with the <code>combineCards.py</code> script:</p>
<div class="highlight"><pre><span></span><code>combineCards.py<span class="w"> </span><span class="nv">signal_region</span><span class="o">=</span>datacard_part3.txt<span class="w"> </span><span class="nv">ttbar_cr</span><span class="o">=</span>datacard_part3_ttbar_cr.txt<span class="w"> </span><span class="nv">DY_cr</span><span class="o">=</span>datacard_part3_DY_cr.txt<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>part3_combined.txt
</code></pre></div>
<p>Each argument is of the form <code>[new channel name]=[datacard.txt]</code>. The new datacard is written to the screen by default, so we redirect the output into our new datacard file. The output looks like:</p>
<details>
<summary><b>Show datacard</b></summary>
<div class="highlight"><pre><span></span><code>imax<span class="w"> </span><span class="m">3</span><span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>bins
jmax<span class="w"> </span><span class="m">8</span><span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>processes<span class="w"> </span>minus<span class="w"> </span><span class="m">1</span>
kmax<span class="w"> </span><span class="m">15</span><span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>nuisance<span class="w"> </span>parameters
----------------------------------------------------------------------------------------------------------------------------------
shapes<span class="w"> </span>*<span class="w">              </span>DY_cr<span class="w">          </span>datacard_part3_DY_cr.shapes.root<span class="w"> </span>DY_control_region/<span class="nv">$PROCESS</span><span class="w"> </span>DY_control_region/<span class="nv">$PROCESS_$SYSTEMATIC</span>
shapes<span class="w"> </span>*<span class="w">              </span>signal_region<span class="w">  </span>datacard_part3.shapes.root<span class="w"> </span>signal_region/<span class="nv">$PROCESS</span><span class="w"> </span>signal_region/<span class="nv">$PROCESS_$SYSTEMATIC</span>
shapes<span class="w"> </span>bbHtautau<span class="w">      </span>signal_region<span class="w">  </span>datacard_part3.shapes.root<span class="w"> </span>signal_region/bbHtautau<span class="nv">$MASS</span><span class="w"> </span>signal_region/bbHtautau<span class="nv">$MASS_$SYSTEMATIC</span>
shapes<span class="w"> </span>*<span class="w">              </span>ttbar_cr<span class="w">       </span>datacard_part3_ttbar_cr.shapes.root<span class="w"> </span>tt_control_region/<span class="nv">$PROCESS</span><span class="w"> </span>tt_control_region/<span class="nv">$PROCESS_$SYSTEMATIC</span>
----------------------------------------------------------------------------------------------------------------------------------
bin<span class="w">          </span>signal_region<span class="w">  </span>ttbar_cr<span class="w">       </span>DY_cr
observation<span class="w">  </span><span class="m">3416</span><span class="w">           </span><span class="m">79251</span><span class="w">          </span><span class="m">365754</span>
----------------------------------------------------------------------------------------------------------------------------------
bin<span class="w">                                               </span>signal_region<span class="w">  </span>signal_region<span class="w">  </span>signal_region<span class="w">  </span>signal_region<span class="w">  </span>signal_region<span class="w">  </span>ttbar_cr<span class="w">       </span>ttbar_cr<span class="w">       </span>ttbar_cr<span class="w">       </span>ttbar_cr<span class="w">       </span>ttbar_cr<span class="w">       </span>DY_cr<span class="w">          </span>DY_cr<span class="w">          </span>DY_cr<span class="w">          </span>DY_cr<span class="w">          </span>DY_cr<span class="w">          </span>DY_cr
process<span class="w">                                           </span>bbHtautau<span class="w">      </span>ttbar<span class="w">          </span>diboson<span class="w">        </span>Ztautau<span class="w">        </span>jetFakes<span class="w">       </span>W<span class="w">              </span>QCD<span class="w">            </span>ttbar<span class="w">          </span>VV<span class="w">             </span>Ztautau<span class="w">        </span>W<span class="w">              </span>QCD<span class="w">            </span>Zmumu<span class="w">          </span>ttbar<span class="w">          </span>VV<span class="w">             </span>Ztautau
process<span class="w">                                           </span><span class="m">0</span><span class="w">              </span><span class="m">1</span><span class="w">              </span><span class="m">2</span><span class="w">              </span><span class="m">3</span><span class="w">              </span><span class="m">4</span><span class="w">              </span><span class="m">5</span><span class="w">              </span><span class="m">6</span><span class="w">              </span><span class="m">1</span><span class="w">              </span><span class="m">7</span><span class="w">              </span><span class="m">3</span><span class="w">              </span><span class="m">5</span><span class="w">              </span><span class="m">6</span><span class="w">              </span><span class="m">8</span><span class="w">              </span><span class="m">1</span><span class="w">              </span><span class="m">7</span><span class="w">              </span><span class="m">3</span>
rate<span class="w">                                              </span><span class="m">198</span>.521<span class="w">        </span><span class="m">683</span>.017<span class="w">        </span><span class="m">96</span>.5185<span class="w">        </span><span class="m">742</span>.649<span class="w">        </span><span class="m">2048</span>.94<span class="w">        </span><span class="m">597</span>.336<span class="w">        </span><span class="m">308</span>.965<span class="w">        </span><span class="m">67280</span>.4<span class="w">        </span><span class="m">10589</span>.6<span class="w">        </span><span class="m">150</span>.025<span class="w">        </span><span class="m">59</span>.9999<span class="w">        </span><span class="m">141</span>.725<span class="w">        </span><span class="m">305423</span><span class="w">         </span><span class="m">34341</span>.1<span class="w">        </span><span class="m">5273</span>.43<span class="w">        </span><span class="m">115</span>.34
----------------------------------------------------------------------------------------------------------------------------------
CMS_eff_b<span class="w">               </span>lnN<span class="w">                       </span><span class="m">1</span>.02<span class="w">           </span><span class="m">1</span>.02<span class="w">           </span><span class="m">1</span>.02<span class="w">           </span><span class="m">1</span>.02<span class="w">           </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-
CMS_eff_e<span class="w">               </span>lnN<span class="w">                       </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span><span class="m">1</span>.02<span class="w">           </span>-<span class="w">              </span>-<span class="w">              </span><span class="m">1</span>.02<span class="w">           </span><span class="m">1</span>.02<span class="w">           </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-<span class="w">              </span>-
...
</code></pre></div>
</details>

<p>The <code>[new channel name]=</code> part of the input arguments is not required, but it gives us control over how the channels in the combined card will be named,
otherwise default values like <code>ch1</code>, <code>ch2</code> etc will be used.</p>
<p>We now have a combined datacard that we can run text2workspace.py on and start doing fits, however there is still one important ingredient missing. Right now the yields of the <code>Ztautau</code> process in the SR and <code>Zmumu</code> in the CR are not connected to each other in any way, and similarly for the <code>ttbar</code> processes. In the fit both would be adjusted by the nuisance parameters only, and constrained to the nominal yields. To remedy this we introduce <code>rateParam</code> directives to the datacard. A <code>rateParam</code> is a new free parameter that multiples the yield of a given process, just in the same way the signal strength <code>r</code> multiplies the signal yield. The syntax of a <code>rateParam</code> line in the datacard is</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>name<span class="o">]</span><span class="w"> </span>rateParam<span class="w"> </span><span class="o">[</span>channel<span class="o">]</span><span class="w"> </span><span class="o">[</span>process<span class="o">]</span><span class="w"> </span><span class="o">[</span>init<span class="o">]</span><span class="w"> </span><span class="o">[</span>min,max<span class="o">]</span>
</code></pre></div>
<p>where <code>name</code> is the chosen name for the parameter, <code>channel</code> and <code>process</code> specify which (channel, process) combination it should affect, <code>init</code> gives the initial value, and optionally <code>[min,max]</code> specifies the ranges on the RooRealVar that will be created. The <code>channel</code> and <code>process</code> arguments support the use of the wildcard <code>*</code> to match multiple entries. <strong>Task:</strong> Add two <code>rateParam</code>s with nominal values of <code>1.0</code> to the end of the combined datacard named <code>rate_ttbar</code> and <code>rate_Zll</code>. The former should affect the <code>ttbar</code> process in all channels, and the latter should affect the <code>Ztautau</code> and <code>Zmumu</code> processes in all channels. Set ranges of <code>[0,5]</code> to both. Note that a <code>rateParam</code> name can be repeated to apply it to multiple processes, e.g.:</p>
<div class="highlight"><pre><span></span><code>rateScale<span class="w"> </span>rateParam<span class="w"> </span>*<span class="w"> </span>procA<span class="w"> </span><span class="m">1</span>.0
rateScale<span class="w"> </span>rateParam<span class="w"> </span>*<span class="w"> </span>procB<span class="w"> </span><span class="m">1</span>.0
</code></pre></div>
<p>is perfectly valid and only one <code>rateParam</code> will be created. These parameters will allow the yields to float in the fit without prior constraint (unlike a regular <code>lnN</code> or <code>shape</code> systematic), with the yields in the CRs and SR tied together.</p>
<p><strong>Tasks and questions:</strong>
  - To compare to the previous approach of fitting the SR only, with cross section and acceptance uncertainties restored, an additional card is provided: <code>datacard_part3_nocrs.txt</code>. Run the same fit on this card to verify the improvement of the SR+CR approach</p>
<h2 id="part-2-setup-validation">Part 2: Setup Validation</h2>
<p>Topics covered in this section:</p>
<ul>
<li>A: Using FitDiagnostics to validate your setup</li>
<li>B: Nuisance parameters impacts</li>
<li>C: Post-fit distributions</li>
</ul>
<blockquote>
<p>[!TIP] 
These steps are usually part of the <strong>unblinding</strong> stage, and are the latest steps request for the <strong>GoingToPreApproval</strong>. L2 will usually ask to see the results of these procedures before letting you progress further in the review. For most analyses, you will need to first run impact and validation blind, and then repeat it on the actual data. </p>
<p>[!INFO]
Analysis datacard must be stored in the <a href="https://gitlab.cern.ch/cms-analysis">CMS analysis GitLab repo</a> GitLab repository. When you request your analysis area, CAT will provide you automatic CI tools that can run all these tests for you every time you commit a change! These are quite flexible and customisable, and you are encouraged to take advantage of them</p>
</blockquote>
<h3 id="a-using-fitdiagnostics">A: Using FitDiagnostics</h3>
<p>Now that we have a working datacard complete with systematic uncertainties, it is important to validate our model. We will explore one of the most commonly used modes of <span style="font-variant:small-caps;">Combine</span>: <code>FitDiagnostics</code> . As well as allowing us to make a <strong>measurement</strong> of some physical quantity (as opposed to just setting a limit on it), this method is useful to gain additional information about the model and the behaviour of the fit. It performs two fits:</p>
<ul>
<li>A "background-only" (b-only) fit: first POI (usually "r") fixed to zero</li>
<li>A "signal+background" (s+b) fit: all POIs are floating</li>
</ul>
<p>With the s+b fit <span style="font-variant:small-caps;">Combine</span> will report the best-fit value of our signal strength modifier <code>r</code>. As well as the usual output file, a file named <code>fitDiagnosticsTest.root</code> is produced which contains additional information. In particular it includes two <code>RooFitResult</code> objects, one for the b-only and one for the s+b fit, which store the fitted values of all the <strong>nuisance parameters (NPs)</strong> and POIs as well as estimates of their uncertainties. The covariance matrix from both fits is also included, from which we can learn about the correlations between parameters. Run the <code>FitDiagnostics</code> method on the workspace we obtained using the SR-only datacard:</p>
<p><div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>FitDiagnostics<span class="w"> </span>workspace_part2.root<span class="w"> </span>-m<span class="w"> </span><span class="m">800</span><span class="w"> </span>--rMin<span class="w"> </span>-20<span class="w"> </span>--rMax<span class="w"> </span><span class="m">20</span>
</code></pre></div>
Open the resulting <code>fitDiagnosticsTest.root</code> interactively and print the contents of the s+b RooFitResult:</p>
<div class="highlight"><pre><span></span><code>root<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>fit_s-&gt;Print<span class="o">()</span>
</code></pre></div>
<details>
<summary><b>Show output</b></summary>

<div class="highlight"><pre><span></span><code>RooFitResult:<span class="w"> </span>minimized<span class="w"> </span>FCN<span class="w"> </span>value:<span class="w"> </span>-2.55338e-05,<span class="w"> </span>estimated<span class="w"> </span>distance<span class="w"> </span>to<span class="w"> </span>minimum:<span class="w"> </span><span class="m">7</span>.54243e-06
<span class="w">                </span>covariance<span class="w"> </span>matrix<span class="w"> </span>quality:<span class="w"> </span>Full,<span class="w"> </span>accurate<span class="w"> </span>covariance<span class="w"> </span>matrix
<span class="w">                </span>Status<span class="w"> </span>:<span class="w"> </span><span class="nv">MINIMIZE</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">HESSE</span><span class="o">=</span><span class="m">0</span>

<span class="w">    </span>Floating<span class="w"> </span>Parameter<span class="w">    </span>FinalValue<span class="w"> </span>+/-<span class="w">  </span>Error
<span class="w">  </span>--------------------<span class="w">  </span>--------------------------
<span class="w">             </span>CMS_eff_b<span class="w">   </span>-4.5380e-02<span class="w"> </span>+/-<span class="w">  </span><span class="m">9</span>.93e-01
<span class="w">             </span>CMS_eff_t<span class="w">   </span>-2.6311e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">7</span>.33e-01
<span class="w">      </span>CMS_eff_t_highpt<span class="w">   </span>-4.7146e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">9</span>.62e-01
<span class="w">  </span>CMS_scale_t_1prong0pi0_13TeV<span class="w">   </span>-1.5989e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">5</span>.93e-01
<span class="w">  </span>CMS_scale_t_1prong1pi0_13TeV<span class="w">   </span>-1.6426e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">4</span>.94e-01
<span class="w">  </span>CMS_scale_t_3prong0pi0_13TeV<span class="w">   </span>-3.0698e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">6</span>.06e-01
<span class="w">    </span>acceptance_Ztautau<span class="w">   </span>-3.1262e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">8</span>.62e-01
<span class="w">        </span>acceptance_bbH<span class="w">   </span>-2.8676e-05<span class="w"> </span>+/-<span class="w">  </span><span class="m">1</span>.00e+00
<span class="w">      </span>acceptance_ttbar<span class="w">    </span><span class="m">4</span>.9981e-03<span class="w"> </span>+/-<span class="w">  </span><span class="m">1</span>.00e+00
<span class="w">            </span>lumi_13TeV<span class="w">   </span>-5.6366e-02<span class="w"> </span>+/-<span class="w">  </span><span class="m">9</span>.89e-01
<span class="w">         </span>norm_jetFakes<span class="w">   </span>-9.3327e-02<span class="w"> </span>+/-<span class="w">  </span><span class="m">2</span>.56e-01
<span class="w">                     </span>r<span class="w">   </span>-2.7220e+00<span class="w"> </span>+/-<span class="w">  </span><span class="m">2</span>.59e+00
<span class="w">    </span>top_pt_ttbar_shape<span class="w">    </span><span class="m">1</span>.7586e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">7</span>.00e-01
<span class="w">          </span>xsec_Ztautau<span class="w">   </span>-1.6007e-01<span class="w"> </span>+/-<span class="w">  </span><span class="m">9</span>.66e-01
<span class="w">          </span>xsec_diboson<span class="w">    </span><span class="m">3</span>.9758e-02<span class="w"> </span>+/-<span class="w">  </span><span class="m">1</span>.00e+00
<span class="w">            </span>xsec_ttbar<span class="w">    </span><span class="m">5</span>.7794e-02<span class="w"> </span>+/-<span class="w">  </span><span class="m">9</span>.46e-01
</code></pre></div>

</details>

<p>There are several useful pieces of information here. At the top the status codes from the fits that were performed is given. In this case we can see that two algorithms were run: <code>MINIMIZE</code> and <code>HESSE</code>, both of which returned a successful status code (0). Both of these are routines in the <strong>Minuit2</strong> minimization package - the default minimizer used in RooFit. The first performs the main fit to the data, and the second calculates the covariance matrix at the best-fit point. It is important to always check this second step was successful and the message "Full, accurate covariance matrix" is printed, otherwise the parameter uncertainties can be very inaccurate, even if the fit itself was successful.</p>
<p>Underneath this the best-fit values (<span class="arithmatex">\(\theta\)</span>) and symmetrised uncertainties for all the floating parameters are given. For all the constrained nuisance parameters a convention is used by which the nominal value (<span class="arithmatex">\(\theta_I\)</span>) is zero, corresponding to the mean of a Gaussian constraint PDF with width 1.0, such that the parameter values <span class="arithmatex">\(\pm 1.0\)</span> correspond to the <span class="arithmatex">\(\pm 1\sigma\)</span> input uncertainties.</p>
<p>A more useful way of looking at this is to compare the pre- and post-fit values of the parameters, to see how much the fit to data has shifted and constrained these parameters with respect to the input uncertainty. The script <code>diffNuisances.py</code> can be used for this:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>diffNuisances.py<span class="w"> </span>fitDiagnosticsTest.root<span class="w"> </span>--all
</code></pre></div>
<details>
<summary><b>Show output</b></summary>

<div class="highlight"><pre><span></span><code>name<span class="w">                                              </span>b-only<span class="w"> </span>fit<span class="w">            </span>s+b<span class="w"> </span>fit<span class="w">         </span>rho
CMS_eff_b<span class="w">                                        </span>-0.04,<span class="w"> </span><span class="m">0</span>.99<span class="w">        </span>-0.05,<span class="w"> </span><span class="m">0</span>.99<span class="w">       </span>+0.01
CMS_eff_t<span class="w">                                     </span>*<span class="w"> </span>-0.24,<span class="w"> </span><span class="m">0</span>.73*<span class="w">     </span>*<span class="w"> </span>-0.26,<span class="w"> </span><span class="m">0</span>.73*<span class="w">       </span>+0.06
CMS_eff_t_highpt<span class="w">                              </span>*<span class="w"> </span>-0.56,<span class="w"> </span><span class="m">0</span>.94*<span class="w">     </span>*<span class="w"> </span>-0.47,<span class="w"> </span><span class="m">0</span>.96*<span class="w">       </span>+0.02
CMS_scale_t_1prong0pi0_13TeV<span class="w">                  </span>*<span class="w"> </span>-0.17,<span class="w"> </span><span class="m">0</span>.58*<span class="w">     </span>*<span class="w"> </span>-0.16,<span class="w"> </span><span class="m">0</span>.59*<span class="w">       </span>-0.04
CMS_scale_t_1prong1pi0_13TeV<span class="w">                  </span>!<span class="w"> </span>-0.12,<span class="w"> </span><span class="m">0</span>.45!<span class="w">     </span>!<span class="w"> </span>-0.16,<span class="w"> </span><span class="m">0</span>.49!<span class="w">       </span>+0.20
CMS_scale_t_3prong0pi0_13TeV<span class="w">                  </span>*<span class="w"> </span>-0.31,<span class="w"> </span><span class="m">0</span>.61*<span class="w">     </span>*<span class="w"> </span>-0.31,<span class="w"> </span><span class="m">0</span>.61*<span class="w">       </span>+0.02
acceptance_Ztautau<span class="w">                            </span>*<span class="w"> </span>-0.31,<span class="w"> </span><span class="m">0</span>.86*<span class="w">     </span>*<span class="w"> </span>-0.31,<span class="w"> </span><span class="m">0</span>.86*<span class="w">       </span>-0.05
acceptance_bbH<span class="w">                                   </span>+0.00,<span class="w"> </span><span class="m">1</span>.00<span class="w">        </span>-0.00,<span class="w"> </span><span class="m">1</span>.00<span class="w">       </span>+0.05
acceptance_ttbar<span class="w">                                 </span>+0.01,<span class="w"> </span><span class="m">1</span>.00<span class="w">        </span>+0.00,<span class="w"> </span><span class="m">1</span>.00<span class="w">       </span>+0.00
lumi_13TeV<span class="w">                                       </span>-0.05,<span class="w"> </span><span class="m">0</span>.99<span class="w">        </span>-0.06,<span class="w"> </span><span class="m">0</span>.99<span class="w">       </span>+0.01
norm_jetFakes<span class="w">                                 </span>!<span class="w"> </span>-0.09,<span class="w"> </span><span class="m">0</span>.26!<span class="w">     </span>!<span class="w"> </span>-0.09,<span class="w"> </span><span class="m">0</span>.26!<span class="w">       </span>-0.05
top_pt_ttbar_shape<span class="w">                            </span>*<span class="w"> </span>+0.24,<span class="w"> </span><span class="m">0</span>.69*<span class="w">     </span>*<span class="w"> </span>+0.18,<span class="w"> </span><span class="m">0</span>.70*<span class="w">       </span>+0.22
xsec_Ztautau<span class="w">                                     </span>-0.16,<span class="w"> </span><span class="m">0</span>.97<span class="w">        </span>-0.16,<span class="w"> </span><span class="m">0</span>.97<span class="w">       </span>-0.02
xsec_diboson<span class="w">                                     </span>+0.03,<span class="w"> </span><span class="m">1</span>.00<span class="w">        </span>+0.04,<span class="w"> </span><span class="m">1</span>.00<span class="w">       </span>-0.02
xsec_ttbar<span class="w">                                       </span>+0.08,<span class="w"> </span><span class="m">0</span>.95<span class="w">        </span>+0.06,<span class="w"> </span><span class="m">0</span>.95<span class="w">       </span>+0.02
</code></pre></div>

</details>

<p>The numbers in each column are respectively <span class="arithmatex">\(\frac{\theta-\theta_I}{\sigma_I}\)</span> (This is often called the pull, but note that this is a misnomer. In this tutorial we will refer to it as the fitted value of the nuisance parameter relative to the input uncertainty. The true pull is defined as discussed under <code>diffPullAsym</code> <a href="https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/nonstandard/#pre-and-post-fit-nuisance-parameters-and-pulls">here</a> ), where <span class="arithmatex">\(\sigma_I\)</span> is the input uncertainty; and the ratio of the post-fit to the pre-fit uncertainty <span class="arithmatex">\(\frac{\sigma}{\sigma_I}\)</span>.</p>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>Using the SR card, Which parameter has the largest shift from the nominal value (0) in the fitted value of the nuisance parameter relative to the input uncertainty? Which has the tightest constraint?</li>
<li>Check how much the cross section measurement and uncertainties change using <code>FitDiagnostics</code>.</li>
<li>It is also useful to check how the expected uncertainty changes using an Asimov dataset, say with <code>r=10</code> injected.</li>
<li>Should we be concerned when a parameter is more strongly constrained than the input uncertainty (i.e. <span class="arithmatex">\(\frac{\sigma}{\sigma_I}&lt;1.0\)</span>)?</li>
<li>Check the fitted values of the nuisance parameters and constraints on a b-only and s+b asimov dataset instead. This check is <a href="https://twiki.cern.ch/twiki/bin/viewauth/CMS/HiggsWG/HiggsPAGPreapprovalChecks">required</a> for all analyses in the Higgs PAG. It serves both as a closure test (do we fit exactly what signal strength we input?) and a way to check whether there are any infeasibly strong constraints while the analysis is still blind (typical example: something has probably gone wrong if we constrain the luminosity uncertainty to 10% of the input!)<ul>
<li>Run <code>text2workspace.py</code> on the combined card (don't forget to set the mass and output name <code>-m 200 -o workspace_part3.root</code>) and then use <code>FitDiagnostics</code> on an Asimov dataset with <code>r=1</code> to get the expected uncertainty. Suggested command line options: <code>--rMin 0 --rMax 2</code></li>
</ul>
</li>
<li>Using the RooFitResult in the <code>fitDiagnosticsTest.root</code> file, check the post-fit value of the rateParams. To what level are the normalisations of the DY and ttbar processes constrained?</li>
<li><strong>Advanced task:</strong> Sometimes there are problems in the fit model that aren't apparent from only fitting the Asimov dataset, but will appear when fitting randomised data. Follow the exercise on toy-by-toy diagnostics <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/nonstandard/#toy-by-toy-diagnostics">here</a> to explore the tools available for this.</li>
</ul>
<h3 id="b-nuisance-parameter-impacts">B: Nuisance parameter impacts</h3>
<p>It is often useful to examine in detail the effects the systematic uncertainties have on the signal strength measurement. This is often referred to as calculating the "impact" of each uncertainty. What this means is to determine the shift in the signal strength, with respect to the best-fit, that is induced if a given nuisance parameter is shifted by its <span class="arithmatex">\(\pm1\sigma\)</span> post-fit uncertainty values. If the signal strength shifts a lot, it tells us that it has a strong dependency on this systematic uncertainty. In fact, what we are measuring here is strongly related to the correlation coefficient between the signal strength and the nuisance parameter. The <code>MultiDimFit</code> method has an algorithm for calculating the impact for a given systematic: <code>--algo impact -P [parameter name]</code>, but it is typical to use a higher-level script, <code>combineTool.py</code>, to automatically run the impacts for all parameters. Full documentation on this is given <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/nonstandard/#nuisance-parameter-impacts">here</a>. There is a three step process for running this. First we perform an initial fit for the signal strength and its uncertainty:</p>
<p><div class="highlight"><pre><span></span><code>combineTool.py<span class="w"> </span>-M<span class="w"> </span>Impacts<span class="w"> </span>-d<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--robustFit<span class="w"> </span><span class="m">1</span><span class="w"> </span>--doInitialFit
</code></pre></div>
Then we run the impacts for all the nuisance parameters:
<div class="highlight"><pre><span></span><code>combineTool.py<span class="w"> </span>-M<span class="w"> </span>Impacts<span class="w"> </span>-d<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--robustFit<span class="w"> </span><span class="m">1</span><span class="w"> </span>--doFits
</code></pre></div>
This will take a little bit of time. When finished we collect all the output and convert it to a json file:
<div class="highlight"><pre><span></span><code>combineTool.py<span class="w"> </span>-M<span class="w"> </span>Impacts<span class="w"> </span>-d<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--robustFit<span class="w"> </span><span class="m">1</span><span class="w"> </span>--output<span class="w"> </span>impacts.json
</code></pre></div>
We can then make a plot showing the fitted values of the nuisance parameters, relative to the input uncertainty, and parameter impacts, sorted by the largest impact:
<div class="highlight"><pre><span></span><code>plotImpacts.py<span class="w"> </span>-i<span class="w"> </span>impacts.json<span class="w"> </span>-o<span class="w"> </span>impacts
</code></pre></div></p>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>Identify the most important uncertainties using the impacts tool.</li>
<li>In the plot, some parameters do not show a fitted value of the nuisance parameter relative to the input uncertainty, but rather just a numerical value - why?</li>
</ul>
<h3 id="c-post-fit-distributions">C: Post-fit distributions</h3>
<p>Another thing the <code>FitDiagnostics</code> mode can help us with is visualising the distributions we are fitting, and the uncertainties on those distributions, both before the fit is performed ("pre-fit") and after ("post-fit"). The pre-fit can give us some idea of how well our uncertainties cover any data-MC discrepancy, and the post-fit if discrepancies remain after the fit to data (as well as possibly letting us see the presence of a significant signal!).</p>
<p>To produce these distributions add the <code>--saveShapes</code> and <code>--saveWithUncertainties</code> options when running <code>FitDiagnostics</code>:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>FitDiagnostics<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--saveShapes<span class="w"> </span>--saveWithUncertainties<span class="w"> </span>-n<span class="w"> </span>.part3B
</code></pre></div>
<p><span style="font-variant:small-caps;">Combine</span> will produce pre- and post-fit distributions (for fit_s and fit_b) in the fitDiagnosticsTest.root output file:</p>
<p><img alt="" src="../../part5/images/fit_diag_shapes.png" /></p>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>
<p>Make a plot showing the expected background and signal contributions using the output from <code>FitDiagnostics</code> - do this for both the pre-fit and post-fit. You will find a script <code>postFitPlot.py</code> in the <code>data/tutorials/longexercise</code> directory that can help you get started.
 The bin errors on the TH1s in the fitDiagnostics file are determined from the systematic uncertainties. In the post-fit these take into account the additional constraints on the nuisance parameters as well as any correlations.</p>
</li>
<li>
<p>Why is the uncertainty on the post-fit so much smaller than on the pre-fit?</p>
</li>
</ul>
<h2 id="part-3-running-the-fit">Part 3: Running the fit</h2>
<p>Topics covered in this section:</p>
<ul>
<li>A: Calculating the significance</li>
<li>B: Signal strength measurement and uncertainty breakdown</li>
<li>C: Computing limits with toys</li>
</ul>
<blockquote>
<p>[!TIP] 
Now you can finally get your final results! The ARC will need to see, check, and comment on your results before they can GL the analysis. While some result can be added to the paper during the ARC review, the main results should be reviewed by L3 and L2 as well and so should be ready by the <strong>preapproval</strong> talk.</p>
</blockquote>
<p>Now that we have a working and validated setup, we can finally perform the statistical analysis of our results. We already saw in the previous sections how to extract limits on our signal under the assumption of the asymptotic regime. <code>Combine</code> provides several other methods to extract different results. In this part we will discuss the most common ones, but you are encouraged to explore the <a href="https://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/runningthetool/">documentation</a> to have a look at the other possibilities offered by the tool.</p>
<h3 id="a-calculating-the-significance">A: Calculating the significance</h3>
<p>In the event that you observe a deviation from your null hypothesis, in this case the b-only hypothesis, <span style="font-variant:small-caps;">Combine</span> can be used to calculate the p-value or significance. To do this using the asymptotic approximation simply do:</p>
<p><div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>Significance<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span>
</code></pre></div>
To calculate the expected significance for a given signal strength we can just generate an Asimov dataset first:</p>
<p><div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>Significance<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">5</span><span class="w"> </span>-t<span class="w"> </span>-1<span class="w"> </span>--expectSignal<span class="w"> </span><span class="m">1</span>.5
</code></pre></div>
Note that the Asimov dataset generated this way uses the nominal values of all model parameters to define the dataset. Another option is to add <code>--toysFrequentist</code>, which causes a fit to the data to be performed first (with <code>r</code> frozen to the <code>--expectSignal</code> value) and then any subsequent Asimov datasets or toys are generated using the post-fit values of the model parameters. In general this will result in a different value for the expected significance due to changes in the background normalisation and shape induced by the fit to data:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>Significance<span class="w"> </span>workspace_part3.root<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">5</span><span class="w"> </span>-t<span class="w"> </span>-1<span class="w"> </span>--expectSignal<span class="w"> </span><span class="m">1</span>.5<span class="w"> </span>--toysFrequentist
</code></pre></div>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>Note how much the expected significance changes with the --toysFrequentist option. Does the change make sense given the difference in the post-fit and pre-fit distributions you looked at in the previous section?</li>
<li><strong>Advanced task</strong> It is also possible to calculate the significance using toys with <code>HybridNew</code> (details <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/commonstatsmethods/#computing-significances-with-toys">here</a>) if we are in a situation where the asymptotic approximation is not reliable or if we just want to verify the result. Why might this be challenging for a high significance, say larger than <span class="arithmatex">\(5\sigma\)</span>?</li>
</ul>
<h3 id="b-signal-strength-measurement-and-uncertainty-breakdown">B: Signal strength measurement and uncertainty breakdown</h3>
<p>We have seen that with <code>FitDiagnostics</code> we can make a measurement of the best-fit signal strength and uncertainty. In the asymptotic approximation we find an interval at the <span class="arithmatex">\(\alpha\)</span> CL around the best fit by identifying the parameter values at which our test statistic <span class="arithmatex">\(q=2\Delta \ln L\)</span> equals a critical value. This value is the <span class="arithmatex">\(\alpha\)</span> quantile of the <span class="arithmatex">\(\chi^2\)</span> distribution with one degree of freedom. In the expression for q we calculate the difference in the profile likelihood between some fixed point and the best-fit.</p>
<p>Depending on what we want to do with the measurement, e.g. whether it will be published in a journal, we may want to choose a more precise method for finding these intervals. There are a number of ways that parameter uncertainties are estimated in combine, and some are more precise than others:</p>
<ul>
<li>Covariance matrix: calculated by the Minuit HESSE routine, this gives a symmetric uncertainty by definition and is only accurate when the profile likelihood for this parameter is symmetric and parabolic.</li>
<li>Minos error: calculated by the Minuit MINOS route - performs a search for the upper and lower values of the parameter that give the critical value of <span class="arithmatex">\(q\)</span> for the desired CL. Return an asymmetric interval. This is what <code>FitDiagnostics</code> does by default, but only for the parameter of interest. Usually accurate but prone to fail on more complex models and not easy to control the tolerance for terminating the search.</li>
<li>RobustFit error: a custom implementation in combine similar to Minos that returns an asymmetric interval, but with more control over the precision. Enabled by adding <code>--robustFit 1</code> when running <code>FitDiagnostics</code>.</li>
<li>Explicit scan of the profile likelihood on a chosen grid of parameter values. Interpolation between points to find parameter values corresponding to appropriate d. It is a good idea to use this for important measurements since we can see by eye that there are no unexpected features in the shape of the likelihood curve.</li>
</ul>
<p>In this section we will look at the last approach, using the <code>MultiDimFit</code> mode of combine. By default this mode just performs a single fit to the data:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>workspace_part3.root<span class="w"> </span>-n<span class="w"> </span>.part3E<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span>
</code></pre></div>
<p>You should see the best-fit value of the signal strength reported and nothing else. By adding the <code>--algo X</code> option combine will run an additional algorithm after this best fit. Here we will use <code>--algo grid</code>, which performs a scan of the likelihood with <code>r</code> fixed to a set of different values. The set of points will be equally spaced between the <code>--rMin</code> and <code>--rMax</code> values, and the number of points is controlled with <code>--points N</code>:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>workspace_part3.root<span class="w"> </span>-n<span class="w"> </span>.part3E<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--algo<span class="w"> </span>grid<span class="w"> </span>--points<span class="w"> </span><span class="m">30</span>
</code></pre></div>
<p>The results of the scan are written into the output file, if opened interactively should see:</p>
<details>
<summary><b>Show output</b></summary>
<div class="highlight"><pre><span></span><code>root<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>limit-&gt;Scan<span class="o">(</span><span class="s2">&quot;r:deltaNLL&quot;</span><span class="o">)</span>
************************************
*<span class="w">    </span>Row<span class="w">   </span>*<span class="w">         </span>r<span class="w"> </span>*<span class="w">  </span>deltaNLL<span class="w"> </span>*
************************************
*<span class="w">        </span><span class="m">0</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.5399457<span class="w"> </span>*<span class="w">         </span><span class="m">0</span><span class="w"> </span>*
*<span class="w">        </span><span class="m">1</span><span class="w"> </span>*<span class="w"> </span>-0.949999<span class="w"> </span>*<span class="w"> </span><span class="m">5</span>.6350698<span class="w"> </span>*
*<span class="w">        </span><span class="m">2</span><span class="w"> </span>*<span class="w"> </span>-0.850000<span class="w"> </span>*<span class="w"> </span><span class="m">4</span>.9482779<span class="w"> </span>*
*<span class="w">        </span><span class="m">3</span><span class="w"> </span>*<span class="w">     </span>-0.75<span class="w"> </span>*<span class="w"> </span><span class="m">4</span>.2942519<span class="w"> </span>*
*<span class="w">        </span><span class="m">4</span><span class="w"> </span>*<span class="w"> </span>-0.649999<span class="w"> </span>*<span class="w"> </span><span class="m">3</span>.6765284<span class="w"> </span>*
*<span class="w">        </span><span class="m">5</span><span class="w"> </span>*<span class="w"> </span>-0.550000<span class="w"> </span>*<span class="w"> </span><span class="m">3</span>.0985388<span class="w"> </span>*
*<span class="w">        </span><span class="m">6</span><span class="w"> </span>*<span class="w"> </span>-0.449999<span class="w"> </span>*<span class="w"> </span><span class="m">2</span>.5635135<span class="w"> </span>*
*<span class="w">        </span><span class="m">7</span><span class="w"> </span>*<span class="w"> </span>-0.349999<span class="w"> </span>*<span class="w"> </span><span class="m">2</span>.0743820<span class="w"> </span>*
*<span class="w">        </span><span class="m">8</span><span class="w"> </span>*<span class="w">     </span>-0.25<span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.6337506<span class="w"> </span>*
*<span class="w">        </span><span class="m">9</span><span class="w"> </span>*<span class="w"> </span>-0.150000<span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.2438088<span class="w"> </span>*
*<span class="w">       </span><span class="m">10</span><span class="w"> </span>*<span class="w"> </span>-0.050000<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.9059833<span class="w"> </span>*
*<span class="w">       </span><span class="m">11</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.0500000<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.6215767<span class="w"> </span>*
*<span class="w">       </span><span class="m">12</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.1500000<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.3910581<span class="w"> </span>*
*<span class="w">       </span><span class="m">13</span><span class="w"> </span>*<span class="w">      </span><span class="m">0</span>.25<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.2144184<span class="w"> </span>*
*<span class="w">       </span><span class="m">14</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.3499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.0911308<span class="w"> </span>*
*<span class="w">       </span><span class="m">15</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.4499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.0201983<span class="w"> </span>*
*<span class="w">       </span><span class="m">16</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.5500000<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.0002447<span class="w"> </span>*
*<span class="w">       </span><span class="m">17</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.6499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.0294311<span class="w"> </span>*
*<span class="w">       </span><span class="m">18</span><span class="w"> </span>*<span class="w">      </span><span class="m">0</span>.75<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.1058298<span class="w"> </span>*
*<span class="w">       </span><span class="m">19</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.8500000<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.2272539<span class="w"> </span>*
*<span class="w">       </span><span class="m">20</span><span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.9499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.3912534<span class="w"> </span>*
*<span class="w">       </span><span class="m">21</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.0499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.5952836<span class="w"> </span>*
*<span class="w">       </span><span class="m">22</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.1499999<span class="w"> </span>*<span class="w"> </span><span class="m">0</span>.8371513<span class="w"> </span>*
*<span class="w">       </span><span class="m">23</span><span class="w"> </span>*<span class="w">      </span><span class="m">1</span>.25<span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.1142146<span class="w"> </span>*
*<span class="w">       </span><span class="m">24</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.3500000<span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.4240909<span class="w"> </span>*
*<span class="w">       </span><span class="m">25</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.4500000<span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.7644306<span class="w"> </span>*
*<span class="w">       </span><span class="m">26</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.5499999<span class="w"> </span>*<span class="w"> </span><span class="m">2</span>.1329684<span class="w"> </span>*
*<span class="w">       </span><span class="m">27</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.6499999<span class="w"> </span>*<span class="w"> </span><span class="m">2</span>.5273966<span class="w"> </span>*
*<span class="w">       </span><span class="m">28</span><span class="w"> </span>*<span class="w">      </span><span class="m">1</span>.75<span class="w"> </span>*<span class="w"> </span><span class="m">2</span>.9458723<span class="w"> </span>*
*<span class="w">       </span><span class="m">29</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.8500000<span class="w"> </span>*<span class="w"> </span><span class="m">3</span>.3863399<span class="w"> </span>*
*<span class="w">       </span><span class="m">30</span><span class="w"> </span>*<span class="w"> </span><span class="m">1</span>.9500000<span class="w"> </span>*<span class="w"> </span><span class="m">3</span>.8469560<span class="w"> </span>*
************************************
</code></pre></div>
</details>

<p>To turn this into a plot run:
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>plot1DScan.py<span class="w"> </span>higgsCombine.part3E.MultiDimFit.mH200.root<span class="w"> </span>-o<span class="w"> </span>single_scan
</code></pre></div>
This script will also perform a spline interpolation of the points to give accurate values for the uncertainties.</p>
<p>In the next step we will split this total uncertainty into two components. It is typical to separate the contribution from statistics and systematics, and sometimes even split the systematic part into different components. This gives us an idea of which aspects of the uncertainty dominate.
The statistical component is usually defined as the uncertainty we would have if all the systematic uncertainties went to zero. We can emulate this effect by freezing all the nuisance parameters when we do the scan in <code>r</code>,
such that they do not vary in the fit. This is achieved by adding the <code>--freezeParameters allConstrainedNuisances</code> option. It would also work if the parameters are specified explicitly, e.g. <code>--freezeParameters CMS_eff_t,lumi_13TeV,...,</code> but the <code>allConstrainedNuisances</code> option is more concise. Run the scan again with the systematics frozen, and use the plotting script to overlay this curve with the previous one:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>workspace_part3.root<span class="w"> </span>-n<span class="w"> </span>.part3E.freezeAll<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--algo<span class="w"> </span>grid<span class="w"> </span>--points<span class="w"> </span><span class="m">30</span><span class="w"> </span>--freezeParameters<span class="w"> </span>allConstrainedNuisances
python<span class="w"> </span>plot1DScan.py<span class="w"> </span>higgsCombine.part3E.MultiDimFit.mH200.root<span class="w"> </span>--others<span class="w"> </span><span class="s1">&#39;higgsCombine.part3E.freezeAll.MultiDimFit.mH200.root:FreezeAll:2&#39;</span><span class="w"> </span>-o<span class="w"> </span>freeze_first_attempt
</code></pre></div>
<p><img alt="" src="../../part5/images/freeze_first_attempt.png" /></p>
<p>This doesn't look quite right - the best-fit has been shifted because unfortunately the <code>--freezeParameters</code> option acts before the initial fit, whereas we only want to add it for the scan after this fit. To remedy this we can use a feature of <span style="font-variant:small-caps;">Combine</span> that lets us save a "snapshot" of the best-fit parameter values, and reuse this snapshot in subsequent fits. First we perform a single fit, adding the <code>--saveWorkspace</code> option:</p>
<p><div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>workspace_part3.root<span class="w"> </span>-n<span class="w"> </span>.part3E.snapshot<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--saveWorkspace
</code></pre></div>
The output file will now contain a copy of our workspace from the input, and this copy will contain a snapshot of the best-fit parameter values. We can now run the frozen scan again, but instead using this copy of the workspace as input, and restoring the snapshot that was saved:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>MultiDimFit<span class="w"> </span>higgsCombine.part3E.snapshot.MultiDimFit.mH200.root<span class="w"> </span>-n<span class="w"> </span>.part3E.freezeAll<span class="w"> </span>-m<span class="w"> </span><span class="m">200</span><span class="w"> </span>--rMin<span class="w"> </span>-1<span class="w"> </span>--rMax<span class="w"> </span><span class="m">2</span><span class="w"> </span>--algo<span class="w"> </span>grid<span class="w"> </span>--points<span class="w"> </span><span class="m">30</span><span class="w"> </span>--freezeParameters<span class="w"> </span>allConstrainedNuisances<span class="w"> </span>--snapshotName<span class="w"> </span>MultiDimFit
python<span class="w"> </span>plot1DScan.py<span class="w"> </span>higgsCombine.part3E.MultiDimFit.mH200.root<span class="w"> </span>--others<span class="w"> </span><span class="s1">&#39;higgsCombine.part3E.freezeAll.MultiDimFit.mH200.root:FreezeAll:2&#39;</span><span class="w"> </span>-o<span class="w"> </span>freeze_second_attempt<span class="w"> </span>--breakdown<span class="w"> </span>Syst,Stat
</code></pre></div>
<p>Now the plot should look correct:</p>
<p><img alt="" src="../../part5/images/freeze_second_attempt.png" /></p>
<p>We added the <code>--breakdown Syst,Stat</code> option to the plotting script to make it calculate the systematic component, which is defined simply as <span class="arithmatex">\(\sigma_{\text{syst}} = \sqrt{\sigma^2_{\text{tot}} - \sigma^2_{\text{stat}}}\)</span>.
To split the systematic uncertainty into different components we just need to run another scan with a subset of the systematics frozen. For example, say we want to split this into experimental and theoretical uncertainties, we would calculate the uncertainties as:</p>
<p><span class="arithmatex">\(\sigma_{\text{theory}} = \sqrt{\sigma^2_{\text{tot}} - \sigma^2_{\text{fr.theory}}}\)</span></p>
<p><span class="arithmatex">\(\sigma_{\text{expt}} = \sqrt{\sigma^2_{\text{fr.theory}} - \sigma^2_{\text{fr.theory+expt}}}\)</span></p>
<p><span class="arithmatex">\(\sigma_{\text{stat}} = \sigma_{\text{fr.theory+expt}}\)</span></p>
<p>where fr.=freeze.</p>
<p>While it is perfectly fine to just list the relevant nuisance parameters in the <code>--freezeParameters</code> argument for the <span class="arithmatex">\(\sigma_{\text{fr.theory}}\)</span> scan, a convenient way can be to define a named group of parameters in the text datacard and then freeze all parameters in this group with <code>--freezeNuisanceGroups</code>. The syntax for defining a group is:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>group<span class="w"> </span>name<span class="o">]</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>uncertainty_1<span class="w"> </span>uncertainty_2<span class="w"> </span>...<span class="w"> </span>uncertainty_N
</code></pre></div>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>Take our stat+syst split one step further and separate the systematic part into two: one part for hadronic tau uncertainties and one for all others.</li>
<li>Do this by defining a <code>tauID</code> group in the datacard including the following parameters: <code>CMS_eff_t</code>, <code>CMS_eff_t_highpt</code>, and the three <code>CMS_scale_t_X</code> uncertainties.</li>
<li>To plot this and calculate the split via the relations above you can just add further arguments to the <code>--others</code> option in the <code>plot1DScan.py</code> script. Each is of the form: <code>'[file]:[label]:[color]'</code>. The <code>--breakdown</code> argument should also be extended to three terms.</li>
<li>How important are these tau-related uncertainties compared to the others?</li>
</ul>
<h3 id="c-computing-limits-with-toys">C: Computing limits with toys</h3>
<p>Now we will look at computing limits without the asymptotic approximation, so instead using toy datasets to determine the test statistic distributions under the signal+background and background-only hypotheses. This can be necessary if we are searching for signal in bins with a small number of events expected. In <span style="font-variant:small-caps;">Combine</span> we will use the <code>HybridNew</code> method to calculate limits using toys. This mode is capable of calculating limits with several different test statistics and with fine-grained control over how the toy datasets are generated internally. To calculate LHC-style profile likelihood limits (i.e. the same as we did with the asymptotic) we set the option <code>--LHCmode LHC-limits</code>. You can read more about the different options in the <a href="http://cms-analysis.github.io/HiggsAnalysis-CombinedLimit/part3/commonstatsmethods/#computing-limits-with-toys">Combine documentation</a>.</p>
<p>Run the following command:
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>HybridNew<span class="w"> </span>datacard_part1.txt<span class="w"> </span>--LHCmode<span class="w"> </span>LHC-limits<span class="w"> </span>-n<span class="w"> </span>.part1B<span class="w"> </span>--saveHybridResult
</code></pre></div>
In contrast to <code>AsymptoticLimits</code> this will only determine the observed limit, and will take a few minutes. There will not be much output to the screen while combine is running. You can add the option <code>-v 1</code> to get a better idea of what is going on. You should see <span style="font-variant:small-caps;">Combine</span> stepping around in <code>r</code>, trying to find the value for which CLs = 0.05, i.e. the 95% CL limit. The <code>--saveHybridResult</code> option will cause the test statistic distributions that are generated at each tested value of <code>r</code> to be saved in the output ROOT file.</p>
<p>To get an expected limit add the option <code>--expectedFromGrid X</code>, where <code>X</code> is the desired quantile, e.g. for the median:</p>
<div class="highlight"><pre><span></span><code>combine<span class="w"> </span>-M<span class="w"> </span>HybridNew<span class="w"> </span>datacard_part1.txt<span class="w"> </span>--LHCmode<span class="w"> </span>LHC-limits<span class="w"> </span>-n<span class="w"> </span>.part1B<span class="w"> </span>--saveHybridResult<span class="w"> </span>--expectedFromGrid<span class="w"> </span><span class="m">0</span>.500
</code></pre></div>
<p>Calculate the median expected limit and the 68% range. The 95% range could also be done, but note it will take much longer to run the 0.025 quantile. While <span style="font-variant:small-caps;">Combine</span> is running you can move on to the next steps below.</p>
<p><strong>Tasks and questions:</strong></p>
<ul>
<li>In contrast to <code>AsymptoticLimits</code>, with <code>HybridNew</code> each limit comes with an uncertainty. What is the origin of this uncertainty?</li>
<li>How good is the agreement between the asymptotic and toy-based methods?</li>
<li>Why does it take longer to calculate the lower expected quantiles (e.g. 0.025, 0.16)? Think about how the statistical uncertainty on the CLs value depends on Pmu and Pb.</li>
</ul>
<p>Next plot the test statistic distributions stored in the output file:
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span><span class="nv">$CMSSW_BASE</span>/src/HiggsAnalysis/CombinedLimit/test/plotTestStatCLs.py<span class="w"> </span>--input<span class="w"> </span>higgsCombine.part1B.HybridNew.mH120.root<span class="w"> </span>--poi<span class="w"> </span>r<span class="w"> </span>--val<span class="w"> </span>all<span class="w"> </span>--mass<span class="w"> </span><span class="m">120</span>
</code></pre></div></p>
<p>This produces a new ROOT file <code>test_stat_distributions.root</code> containing the plots, to save them as pdf/png files run this small script and look at the resulting figures:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>printTestStatPlots.py<span class="w"> </span>test_stat_distributions.root
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../part5/longexerciseanswers/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Solutions">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Solutions
              </div>
            </div>
          </a>
        
        
          
          <a href="../../tutorial2023/parametric_exercise/" class="md-footer__link md-footer__link--next" aria-label="Next: Parametric Models">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Parametric Models
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "navigation.footer", "navigation.indexes", "navigation.expand", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "search.highlight", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill-fastly.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>